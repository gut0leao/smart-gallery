#!/bin/bash

## Description: Script para automatizar a configuraÃ§Ã£o inicial do WordPress
## Usage: ddev setup-wordpress
## Example: ddev setup-wordpress

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ WordPress Setup Script${NC}"
echo ""

# Verificar se WordPress jÃ¡ estÃ¡ instalado
echo "ğŸ” Verificando instalaÃ§Ã£o existente..."
if ddev wp core is-installed 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  WORDPRESS JÃ ESTÃ INSTALADO!${NC}"
    echo ""
    echo -e "${RED}ğŸš¨ ATENÃ‡ÃƒO: Este script farÃ¡ uma instalaÃ§Ã£o COMPLETA do zero:${NC}"
    echo "   â€¢ Todos os dados do WordPress serÃ£o PERDIDOS"
    echo "   â€¢ Banco de dados serÃ¡ RECRIADO"
    echo "   â€¢ Posts, pÃ¡ginas, usuÃ¡rios, configuraÃ§Ãµes serÃ£o APAGADOS"
    echo "   â€¢ Arquivos de configuraÃ§Ã£o serÃ£o SOBRESCRITOS"
    echo ""
    echo -e "${BLUE}ğŸ’¡ Se vocÃª quer apenas atualizar plugins/temas sem perder dados, cancele e:"
    echo "   â€¢ Use comandos individuais: ddev wp plugin install [plugin]"
    echo "   â€¢ Ou use o wp-admin para instalaÃ§Ãµes manuais${NC}"
    echo ""
    echo -e "${RED}âš ï¸  Esta aÃ§Ã£o Ã© IRREVERSÃVEL!${NC}"
    echo ""
    
    read -p "Tem certeza que quer REINSTALAR WordPress do zero? (y/N): " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}ğŸ˜Œ Cancelado. Sua instalaÃ§Ã£o WordPress permanece intacta.${NC}"
        exit 0
    fi
    
    echo -e "${RED}ğŸ”¥ Prosseguindo com reinstalaÃ§Ã£o completa...${NC}"
    echo ""
else
    echo -e "${GREEN}âœ… Nenhuma instalaÃ§Ã£o WordPress detectada. Prosseguindo com instalaÃ§Ã£o limpa...${NC}"
    echo ""
fi

echo "ğŸ” Configurando HTTPS com mkcert..."

# Verificar se estÃ¡ rodando no WSL
if [[ -f /proc/version ]] && grep -q Microsoft /proc/version; then
    echo "ğŸ§ Detectado WSL (Windows Subsystem for Linux)"
    echo "ğŸ“ InstruÃ§Ãµes para WSL:"
    echo "   1. Instale mkcert no WSL: sudo apt install mkcert"
    echo "   2. Instale mkcert no Windows tambÃ©m (via Chocolatey ou GitHub)"
    echo "   3. Execute mkcert -install no WSL E no Windows"
    echo "   4. Certifique-se de que o navegador estÃ¡ rodando no Windows"
    echo ""
fi

# Verificar se mkcert estÃ¡ instalado
if ! command -v mkcert &> /dev/null; then
    echo "âŒ mkcert nÃ£o estÃ¡ instalado."
    if [[ -f /proc/version ]] && grep -q Microsoft /proc/version; then
        echo "   Para WSL, instale com: sudo apt update && sudo apt install mkcert"
        echo "   TambÃ©m instale no Windows: https://github.com/FiloSottile/mkcert"
    else
        echo "   Instale primeiro com: apt install mkcert ou brew install mkcert"
    fi
    exit 1
fi

# Instalar a CA local do mkcert se ainda nÃ£o estiver instalada
echo "ğŸ”‘ Instalando autoridade certificadora local..."
if [[ -f /proc/version ]] && grep -q Microsoft /proc/version; then
    echo "âš ï¸  WSL detectado: ApÃ³s este comando, execute tambÃ©m 'mkcert -install' no Windows!"
fi
mkcert -install 2>/dev/null || true

echo "ğŸ”„ Reiniciando DDEV para aplicar certificados SSL..."
ddev restart

echo "ğŸ“¥ Baixando arquivos do WordPress..."
ddev wp core download --force

echo "ğŸ› ï¸  Instalando WordPress..."
ddev wp core install --url="https://smart-gallery-filter.ddev.site" --title="Smart Gallery Filter" --admin_user="admin" --admin_password="admin" --admin_email="admin@local.test"

echo "ğŸ”’ Configurando WordPress para usar HTTPS..."
ddev wp option update home "https://smart-gallery-filter.ddev.site"
ddev wp option update siteurl "https://smart-gallery-filter.ddev.site"

echo "ğŸ”Œ Verificando plugin smart-gallery-filter..."
if ddev wp plugin is-installed smart-gallery-filter 2>/dev/null; then
    ddev wp plugin activate smart-gallery-filter
    echo "   âœ… Plugin smart-gallery-filter ativado"
else
    echo -e "   ${YELLOW}âš ï¸  Plugin smart-gallery-filter nÃ£o encontrado no diretÃ³rio wp-content/plugins/${NC}"
    echo "   â„¹ï¸  Certifique-se de que o plugin estÃ¡ no local correto"
fi

echo "ğŸ”ŒğŸ—‘ï¸  Removendo plugins desnecessÃ¡rios..."
# Tentar remover plugins padrÃ£o se existirem
if ddev wp plugin is-installed akismet 2>/dev/null; then
    ddev wp plugin uninstall akismet
    echo "   âœ… Akismet removido"
else
    echo "   â„¹ï¸  Akismet nÃ£o encontrado"
fi

if ddev wp plugin is-installed hello 2>/dev/null; then
    ddev wp plugin uninstall hello
    echo "   âœ… Hello Dolly removido" 
else
    echo "   â„¹ï¸  Hello Dolly nÃ£o encontrado"
fi

echo "ğŸ”ŒğŸ“¥ Instalando e ativando plugins: elementor, pods"
ddev wp plugin install elementor pods --activate

echo "ğŸ¨ğŸ“¥ Instalando e ativando tema hello-biz"
ddev wp theme install hello-biz --activate

echo ""
echo -e "${GREEN}ğŸ‰ ConfiguraÃ§Ã£o WordPress concluÃ­da com sucesso!${NC}"
echo ""
echo -e "${BLUE}ğŸ“‹ InformaÃ§Ãµes de acesso:${NC}"
echo "ğŸ”— Site: https://smart-gallery-filter.ddev.site"
echo "ğŸ‘¤ Admin: admin / admin"
echo "ğŸ“§ Email: admin@local.test"
echo ""
echo -e "${YELLOW}ğŸ”„ PrÃ³ximos passos sugeridos:${NC}"
echo "   1. Acesse o wp-admin e configure o Elementor"
echo "   2. Execute './demo-data/pods-import.sh' para importar dados de teste"
echo "   3. Verifique se todos os plugins estÃ£o funcionando"
echo ""

ddev describe
