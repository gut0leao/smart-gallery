name: 4. Configure environment ‚öôÔ∏èname: 4. Configure environment ‚öôÔ∏èname: 4. Configure environment ‚öôÔ∏è



on:

  workflow_dispatch:

    inputs:on:on:

      project_id:

        description: 'GCP Project ID (optional if stored as variable)'  workflow_dispatch:  workflow_dispatch:

        required: false

        type: string    inputs:    inputs:

      vm_instance:

        description: 'VM Instance Name (optional if stored as variable)'      project_id:      project_id:

        required: false

        type: string        description: 'GCP Project ID (optional if stored as variable)'        description: 'GCP Project ID (optional if stored as variable)'

      vm_zone:

        description: 'VM Zone (optional if stored as variable)'        required: false                # Verify WP-CLI is available

        required: false

        type: string        type: string          echo "üîß Verifying WP-CLI installation..."

      domain_name:

        description: 'Domain name'      vm_instance:          if ! /usr/local/bin/wp --version >/dev/null 2>&1; then

        required: true

        type: string        description: 'VM Instance Name (optional if stored as variable)'            echo "‚ùå WP-CLI not found at /usr/local/bin/wp!"

      site_title:

        description: 'WordPress Site Title'        required: false            echo "üí° Please run the 'Install Packages' workflow first."

        required: false

        default: 'Smart Gallery Demo'        type: string            exit 1

        type: string

      admin_user:      vm_zone:          else

        description: 'WordPress Admin Username'

        required: false        description: 'VM Zone (optional if stored as variable)'            echo "‚úÖ WP-CLI is available: \$(/usr/local/bin/wp --version)"

        default: 'admin'

        type: string        required: false          fid: false

      admin_email:

        description: 'WordPress Admin Email'        type: string        type: string

        required: true

        type: string      domain_name:      vm_instance:

      letsencrypt_email:

        description: "Let's Encrypt Email"        description: 'Domain name'        description: 'VM Instance Name (optional if stored as variable)'

        required: true

        type: string        required: true        required: false



env:        type: string        type: string

  GCP_PROJECT_ID: ${{ github.event.inputs.project_id || vars.GCP_PROJECT_ID }}

  VM_INSTANCE: ${{ github.event.inputs.vm_instance || vars.GCP_VM_INSTANCE }}      site_title:      vm_zone:

  VM_ZONE: ${{ github.event.inputs.vm_zone || vars.GCP_VM_ZONE }}

  DOMAIN_NAME: ${{ github.event.inputs.domain_name }}        description: 'WordPress Site Title'        description: 'VM Zone (optional if stored as variable)'

  SITE_TITLE: ${{ github.event.inputs.site_title }}

  ADMIN_USER: ${{ github.event.inputs.admin_user }}        required: false        required: false

  ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}

  LETSENCRYPT_EMAIL: ${{ github.event.inputs.letsencrypt_email }}        default: 'Smart Gallery Demo'        type: string



jobs:        type: string      domain_name:

  configure:

    name: Configure Environment      admin_user:        description: 'Domain name'

    runs-on: ubuntu-latest

            description: 'WordPress Admin Username'        required: true

    outputs:

      site_url: ${{ steps.configure.outputs.site_url }}        required: false        type: string

      admin_password: ${{ steps.configure.outputs.admin_password }}

            default: 'admin'      site_title:

    steps:

      - name: üì• Checkout Repository        type: string        description: 'WordPress Site Title'

        uses: actions/checkout@v4

      admin_email:        required: false

      - name: üîê Authenticate to Google Cloud

        uses: google-github-actions/auth@v2        description: 'WordPress Admin Email'        default: 'Smart Gallery Demo'

        with:

          credentials_json: ${{ secrets.GCP_SA_KEY }}        required: true        type: string

          project_id: ${{ env.GCP_PROJECT_ID }}

        type: string      admin_user:

      - name: ‚òÅÔ∏è Setup Google Cloud SDK

        uses: google-github-actions/setup-gcloud@v2      letsencrypt_email:        description: 'WordPress Admin Username'



      - name: üìù Create Configuration Script        description: "Let's Encrypt Email"        required: false

        run: |

          cat > configure-environment.sh << 'EOF'        required: true        default: 'admin'

          #!/bin/bash

          set -e        type: string        type: string

          exec > >(tee /var/log/environment-configuration.log)

          exec 2>&1      admin_email:

          

          DOMAIN_NAME="$1"env:        description: 'WordPress Admin Email'

          SITE_TITLE="$2"

          ADMIN_USER="$3"  GCP_PROJECT_ID: ${{ github.event.inputs.project_id || vars.GCP_PROJECT_ID }}        required: true

          ADMIN_EMAIL="$4"

          LETSENCRYPT_EMAIL="$5"  VM_INSTANCE: ${{ github.event.inputs.vm_instance || vars.GCP_VM_INSTANCE }}        type: string

          

          echo "‚öôÔ∏è Smart Gallery Environment Configuration - $(date)"  VM_ZONE: ${{ github.event.inputs.vm_zone || vars.GCP_VM_ZONE }}      letsencrypt_email:

          echo "Domain: $DOMAIN_NAME"

          echo "Site Title: $SITE_TITLE"  DOMAIN_NAME: ${{ github.event.inputs.domain_name }}        description: "Let's Encrypt Email"

          echo "Admin User: $ADMIN_USER"

          echo "Admin Email: $ADMIN_EMAIL"  SITE_TITLE: ${{ github.event.inputs.site_title }}        required: true

          

          # Load database credentials  ADMIN_USER: ${{ github.event.inputs.admin_user }}        type: string

          source /root/.wp-db-config

            ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}

          # Generate secure passwords

          ADMIN_PASSWORD=$(openssl rand -base64 24)  LETSENCRYPT_EMAIL: ${{ github.event.inputs.letsencrypt_email }}env:

          DB_ROOT_PASSWORD=$(openssl rand -base64 32)

            GCP_PROJECT_ID: ${{ github.event.inputs.project_id || vars.GCP_PROJECT_ID }}

          # Set MariaDB root password

          echo "üîí Setting MariaDB root password..."jobs:  VM_INSTANCE: ${{ github.event.inputs.vm_instance || vars.GCP_VM_INSTANCE }}

          mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_ROOT_PASSWORD';"

            configure:  VM_ZONE: ${{ github.event.inputs.vm_zone || vars.GCP_VM_ZONE }}

          # Store root password

          echo "[client]" > /root/.my.cnf    name: Configure Environment  DOMAIN_NAME: ${{ github.event.inputs.domain_name }}

          echo "user=root" >> /root/.my.cnf

          echo "password=$DB_ROOT_PASSWORD" >> /root/.my.cnf    runs-on: ubuntu-latest  SITE_TITLE: ${{ github.event.inputs.site_title }}

          chmod 600 /root/.my.cnf

                ADMIN_USER: ${{ github.event.inputs.admin_user }}

          # Configure Nginx

          echo "üåê Configuring Nginx..."    outputs:  ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}

          rm -f /etc/nginx/sites-enabled/default

                site_url: ${{ steps.configure.outputs.site_url }}  LETSENCRYPT_EMAIL: ${{ github.event.inputs.letsencrypt_email }}

          cat > /etc/nginx/sites-available/wordpress <<'NGINX_CONF'

          server {      admin_password: ${{ steps.configure.outputs.admin_password }}

              listen 80;

              server_name $DOMAIN_NAME;    jobs:

              root /var/www/html;

              index index.php index.html index.htm;    steps:  configure:

              

              add_header X-Frame-Options "SAMEORIGIN" always;      # Checkout repository    name: Configure Environment

              add_header X-XSS-Protection "1; mode=block" always;

              add_header X-Content-Type-Options "nosniff" always;      - name: üì• Checkout Repository    runs-on: ubuntu-latest

              add_header Referrer-Policy "no-referrer-when-downgrade" always;

              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;        uses: actions/checkout@v4    

              

              gzip on;    outputs:

              gzip_vary on;

              gzip_min_length 1024;      # Authenticate to GCP      site_url: ${{ steps.configure.outputs.site_url }}

              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;

                    - name: üîê Authenticate to Google Cloud      admin_password: ${{ steps.configure.outputs.admin_password }}

              location = /favicon.ico { log_not_found off; access_log off; }

              location = /robots.txt { allow all; log_not_found off; access_log off; }        uses: google-github-actions/auth@v2    

              location / { try_files \$uri \$uri/ /index.php?\$args; }

              location ~ \.php$ {        with:    steps:

                  include snippets/fastcgi-php.conf;

                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;          credentials_json: ${{ secrets.GCP_SA_KEY }}      # Checkout repository

                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;

                  include fastcgi_params;          project_id: ${{ env.GCP_PROJECT_ID }}      - name: üì• Checkout Repository

              }

              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {        uses: actions/checkout@v4

                  expires 1y;

                  add_header Cache-Control "public, immutable";      # Setup Google Cloud SDK

              }

              location ~ /\. { deny all; }      - name: ‚òÅÔ∏è Setup Google Cloud SDK      # Authenticate to GCP

              location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt) { deny all; }

          }        uses: google-github-actions/setup-gcloud@v2      - name: üîê Authenticate to Google Cloud

          NGINX_CONF

                  uses: google-github-actions/auth@v2

          ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/

          nginx -t      # Create configuration script        with:

          systemctl reload nginx

                - name: üìù Create Configuration Script          credentials_json: ${{ secrets.GCP_SA_KEY }}

          # Verify WP-CLI is available

          echo "üîß Verifying WP-CLI installation..."        run: |          project_id: ${{ env.GCP_PROJECT_ID }}

          if ! /usr/local/bin/wp --version >/dev/null 2>&1; then

            echo "‚ùå WP-CLI not found at /usr/local/bin/wp!"          cat > configure-environment.sh << 'EOF'

            echo "üí° Please run the 'Install Packages' workflow first."

            exit 1          #!/bin/bash      # Setup Google Cloud SDK

          else

            echo "‚úÖ WP-CLI is available: \$(/usr/local/bin/wp --version)"          # Environment configuration script      - name: ‚òÅÔ∏è Setup Google Cloud SDK

          fi

                            uses: google-github-actions/setup-gcloud@v2

          # Download and install WordPress

          echo "üì• Installing WordPress..."          set -e

          cd /var/www/html

          rm -rf *          exec > >(tee /var/log/environment-configuration.log)      # Create configuration script

          

          /usr/local/bin/wp core download --allow-root          exec 2>&1      - name: üìù Create Configuration Script

          

          /usr/local/bin/wp config create \                  run: |

              --dbname=$DB_NAME \

              --dbuser=$DB_USER \          DOMAIN_NAME="$1"          cat > configure-environment.sh << 'EOF'

              --dbpass=$DB_PASS \

              --dbhost=localhost \          SITE_TITLE="$2"          #!/bin/bash

              --allow-root

                    ADMIN_USER="$3"          # Environment configuration script

          /usr/local/bin/wp core install \

              --url="http://$DOMAIN_NAME" \          ADMIN_EMAIL="$4"          

              --title="$SITE_TITLE" \

              --admin_user=$ADMIN_USER \          LETSENCRYPT_EMAIL="$5"          set -e

              --admin_password=$ADMIN_PASSWORD \

              --admin_email=$ADMIN_EMAIL \                    exec > >(tee /var/log/environment-configuration.log)

              --allow-root

                    echo "‚öôÔ∏è Smart Gallery Environment Configuration - $(date)"          exec 2>&1

          # Configure WordPress settings

          echo "‚öôÔ∏è Configuring WordPress..."          echo "Domain: $DOMAIN_NAME"          

          /usr/local/bin/wp option update permalink_structure '/%postname%/' --allow-root

          /usr/local/bin/wp option update timezone_string 'UTC' --allow-root          echo "Site Title: $SITE_TITLE"          DOMAIN_NAME="$1"

          

          # Set proper file permissions          echo "Admin User: $ADMIN_USER"          SITE_TITLE="$2"

          chown -R www-data:www-data /var/www/html

          find /var/www/html -type d -exec chmod 755 {} \;          echo "Admin Email: $ADMIN_EMAIL"          ADMIN_USER="$3"

          find /var/www/html -type f -exec chmod 644 {} \;

          chmod 600 /var/www/html/wp-config.php                    ADMIN_EMAIL="$4"

          

          # Install essential plugins          # Load database credentials          LETSENCRYPT_EMAIL="$5"

          echo "üîå Installing essential plugins..."

          /usr/local/bin/wp plugin install elementor --activate --allow-root          source /root/.wp-db-config          

          /usr/local/bin/wp plugin install pods --activate --allow-root

          /usr/local/bin/wp plugin install wordpress-seo --activate --allow-root                    echo "‚öôÔ∏è Smart Gallery Environment Configuration - $(date)"

          /usr/local/bin/wp plugin install wordfence --activate --allow-root

                    # Generate secure passwords          echo "Domain: $DOMAIN_NAME"

          # Create demo content

          echo "üìù Creating demo content..."          ADMIN_PASSWORD=$(openssl rand -base64 24)          echo "Site Title: $SITE_TITLE"

          /usr/local/bin/wp post create \

              --post_type=page \          DB_ROOT_PASSWORD=$(openssl rand -base64 32)          echo "Admin User: $ADMIN_USER"

              --post_title='Smart Gallery Demo' \

              --post_content='<p>This page will showcase the Smart Gallery plugin functionality.</p>' \                    echo "Admin Email: $ADMIN_EMAIL"

              --post_status=publish \

              --allow-root          # Set MariaDB root password          

          

          # Configure SSL with Let's Encrypt          echo "üîí Setting MariaDB root password..."          # Load database credentials

          echo "üîí Setting up SSL certificate..."

          certbot --nginx \          mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_ROOT_PASSWORD';"          source /root/.wp-db-config

              --non-interactive \

              --agree-tos \                    

              --email $LETSENCRYPT_EMAIL \

              --domains $DOMAIN_NAME \          # Store root password          # Generate secure passwords

              --redirect

                    echo "[client]" > /root/.my.cnf          ADMIN_PASSWORD=$(openssl rand -base64 24)

          # Update WordPress URL to HTTPS

          /usr/local/bin/wp option update home "https://$DOMAIN_NAME" --allow-root          echo "user=root" >> /root/.my.cnf          DB_ROOT_PASSWORD=$(openssl rand -base64 32)

          /usr/local/bin/wp option update siteurl "https://$DOMAIN_NAME" --allow-root

                    echo "password=$DB_ROOT_PASSWORD" >> /root/.my.cnf          

          # Setup auto-renewal

          echo "üîÑ Setting up certificate auto-renewal..."          chmod 600 /root/.my.cnf          # Set MariaDB root password

          if ! crontab -l 2>/dev/null | grep -q 'certbot renew'; then

              (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -                    echo "üîí Setting MariaDB root password..."

          fi

                    # Configure Nginx          mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_ROOT_PASSWORD';"

          # Store credentials for later use

          echo "ADMIN_USER=$ADMIN_USER" > /root/.wp-admin-config          echo "üåê Configuring Nginx..."          

          echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> /root/.wp-admin-config

          echo "ADMIN_EMAIL=$ADMIN_EMAIL" >> /root/.wp-admin-config                    # Store root password

          echo "SITE_URL=https://$DOMAIN_NAME" >> /root/.wp-admin-config

          chmod 600 /root/.wp-admin-config          # Remove default site          echo "[client]" > /root/.my.cnf

          

          systemctl reload nginx          rm -f /etc/nginx/sites-enabled/default          echo "user=root" >> /root/.my.cnf

          

          echo "‚úÖ Environment configuration completed successfully!"                    echo "password=$DB_ROOT_PASSWORD" >> /root/.my.cnf

          echo "üåê Site URL: https://$DOMAIN_NAME"

          echo "üë§ Admin User: $ADMIN_USER"          # Create WordPress site configuration          chmod 600 /root/.my.cnf

          echo "üîë Admin Password: $ADMIN_PASSWORD"

          echo "üìß Admin Email: $ADMIN_EMAIL"          cat > /etc/nginx/sites-available/wordpress <<'NGINX_CONF'          

          

          touch /var/log/environment-configured          server {          # Configure Nginx

          EOF

                        listen 80;          echo "üåê Configuring Nginx..."

          chmod +x configure-environment.sh

              server_name $DOMAIN_NAME;          

      - name: ‚öôÔ∏è Configure Environment on VM

        id: configure              root /var/www/html;          # Remove default site

        run: |

          echo "‚öôÔ∏è Starting environment configuration..."              index index.php index.html index.htm;          rm -f /etc/nginx/sites-enabled/default

          

          gcloud compute scp configure-environment.sh \                        

            $VM_INSTANCE:~/configure-environment.sh \

            --zone=$VM_ZONE \              # Security headers          # Create WordPress site configuration

            --quiet

                        add_header X-Frame-Options "SAMEORIGIN" always;          cat > /etc/nginx/sites-available/wordpress <<'NGINX_CONF'

          gcloud compute ssh $VM_INSTANCE \

            --zone=$VM_ZONE \              add_header X-XSS-Protection "1; mode=block" always;          server {

            --quiet \

            --command="              add_header X-Content-Type-Options "nosniff" always;              listen 80;

              sudo chmod +x ~/configure-environment.sh

              sudo ~/configure-environment.sh \              add_header Referrer-Policy "no-referrer-when-downgrade" always;              server_name $DOMAIN_NAME;

                '$DOMAIN_NAME' \

                '$SITE_TITLE' \              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;              root /var/www/html;

                '$ADMIN_USER' \

                '$ADMIN_EMAIL' \                            index index.php index.html index.htm;

                '$LETSENCRYPT_EMAIL'

            "              # Gzip compression              

          

          ADMIN_PASSWORD=$(gcloud compute ssh $VM_INSTANCE \              gzip on;              # Security headers

            --zone=$VM_ZONE \

            --quiet \              gzip_vary on;              add_header X-Frame-Options "SAMEORIGIN" always;

            --command="sudo grep 'ADMIN_PASSWORD=' /root/.wp-admin-config | cut -d'=' -f2")

                        gzip_min_length 1024;              add_header X-XSS-Protection "1; mode=block" always;

          echo "site_url=https://$DOMAIN_NAME" >> $GITHUB_OUTPUT

          echo "admin_password=$ADMIN_PASSWORD" >> $GITHUB_OUTPUT              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;              add_header X-Content-Type-Options "nosniff" always;

          

          echo "‚úÖ Environment configuration completed!"                            add_header Referrer-Policy "no-referrer-when-downgrade" always;



      - name: üè• Health Check              location = /favicon.ico { log_not_found off; access_log off; }              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

        env:

          SITE_URL: https://${{ env.DOMAIN_NAME }}              location = /robots.txt { allow all; log_not_found off; access_log off; }              

        run: |

          echo "üè• Running health check..."              location / { try_files \$uri \$uri/ /index.php?\$args; }              # Gzip compression

          sleep 30

                        location ~ \.php$ {              gzip on;

          echo "üîç Testing HTTP to HTTPS redirect..."

          if curl -sSL -w "%{http_code}" "http://$DOMAIN_NAME" -o /dev/null | grep -q "30[1-8]"; then                  include snippets/fastcgi-php.conf;              gzip_vary on;

            echo "‚úÖ HTTP redirects to HTTPS!"

          else                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;              gzip_min_length 1024;

            echo "‚ö†Ô∏è HTTP redirect may not be working"

          fi                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;

          

          echo "üîç Testing HTTPS site..."                  include fastcgi_params;              

          if curl -sSf "$SITE_URL" > /dev/null; then

            echo "‚úÖ HTTPS site is responding!"              }              location = /favicon.ico { log_not_found off; access_log off; }

          else

            echo "‚ùå HTTPS site health check failed!"              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {              location = /robots.txt { allow all; log_not_found off; access_log off; }

            exit 1

          fi                  expires 1y;              location / { try_files \$uri \$uri/ /index.php?\$args; }

          

          echo "üîç Testing WordPress admin..."                  add_header Cache-Control "public, immutable";              location ~ \.php$ {

          if curl -sSf "$SITE_URL/wp-admin/" > /dev/null; then

            echo "‚úÖ WordPress admin is accessible!"              }                  include snippets/fastcgi-php.conf;

          else

            echo "‚ö†Ô∏è WordPress admin may need attention"              location ~ /\. { deny all; }                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;

          fi

                        location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt) { deny all; }                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;

          echo "üéâ Health check completed!"

          }                  include fastcgi_params;

      - name: üìä Configuration Summary

        env:          NGINX_CONF              }

          SITE_URL: ${{ steps.configure.outputs.site_url }}

          ADMIN_PASSWORD: ${{ steps.configure.outputs.admin_password }}                        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {

        run: |

          echo "## ‚öôÔ∏è Environment Configuration Summary" >> $GITHUB_STEP_SUMMARY          # Enable site                  expires 1y;

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ‚úÖ WordPress Installation:" >> $GITHUB_STEP_SUMMARY          ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/                  add_header Cache-Control "public, immutable";

          echo "- **Site URL**: $SITE_URL" >> $GITHUB_STEP_SUMMARY

          echo "- **Admin User**: \`$ADMIN_USER\`" >> $GITHUB_STEP_SUMMARY                        }

          echo "- **Admin Password**: \`$ADMIN_PASSWORD\`" >> $GITHUB_STEP_SUMMARY

          echo "- **Admin Email**: $ADMIN_EMAIL" >> $GITHUB_STEP_SUMMARY          # Test and reload Nginx              location ~ /\. { deny all; }

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üîí Security Features:" >> $GITHUB_STEP_SUMMARY          nginx -t              location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt) { deny all; }

          echo "- ‚úÖ SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ HTTPS Redirect" >> $GITHUB_STEP_SUMMARY          systemctl reload nginx          }

          echo "- ‚úÖ Security Headers" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Wordfence Security Plugin" >> $GITHUB_STEP_SUMMARY                    NGINX_CONF

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üîå Installed Plugins:" >> $GITHUB_STEP_SUMMARY          # Verify WP-CLI is available          

          echo "- ‚úÖ Elementor" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Pods Framework" >> $GITHUB_STEP_SUMMARY          echo "üîß Verifying WP-CLI installation..."          # Enable site

          echo "- ‚úÖ WordPress SEO" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Wordfence Security" >> $GITHUB_STEP_SUMMARY          if ! /usr/local/bin/wp --version >/dev/null 2>&1; then          ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üéØ Next Steps:" >> $GITHUB_STEP_SUMMARY            echo "‚ùå WP-CLI not found at /usr/local/bin/wp!"          

          echo "1. Run **Deploy Plugin** workflow" >> $GITHUB_STEP_SUMMARY

          echo "2. Access admin at: $SITE_URL/wp-admin/" >> $GITHUB_STEP_SUMMARY            echo "üí° Please run the 'Install Packages' workflow first."          # Test and reload Nginx

          echo "3. Configure Smart Gallery widget in Elementor" >> $GITHUB_STEP_SUMMARY

            exit 1          nginx -t

      - name: üóëÔ∏è Cleanup

        if: always()          else          systemctl reload nginx

        run: |

          rm -f configure-environment.sh            echo "‚úÖ WP-CLI is available: \$(/usr/local/bin/wp --version)"          

          echo "‚úÖ Configuration workflow completed"
          fi          # Verify WP-CLI is available

                    echo "üîß Verifying WP-CLI installation..."

          # Download and install WordPress          if ! wp --version >/dev/null 2>&1; then

          echo "üì• Installing WordPress..."            echo "‚ùå WP-CLI not found! Please run the 'Install Packages' workflow first."

          cd /var/www/html            echo "ÔøΩ The Install Packages workflow should have installed WP-CLI."

                      exit 1

          # Remove any existing files          else

          rm -rf *            echo "‚úÖ WP-CLI is available: \$(wp --version)"

                    fi

          # Download WordPress          

          /usr/local/bin/wp core download --allow-root          # Download and install WordPress

                    echo "üì• Installing WordPress..."

          # Create wp-config.php          cd /var/www/html

          /usr/local/bin/wp config create \          

              --dbname=$DB_NAME \          # Remove any existing files

              --dbuser=$DB_USER \          rm -rf *

              --dbpass=$DB_PASS \          

              --dbhost=localhost \          # Download WordPress

              --allow-root          /usr/local/bin/wp core download --allow-root

                    

          # Install WordPress          # Create wp-config.php

          /usr/local/bin/wp core install \          /usr/local/bin/wp config create \

              --url="http://$DOMAIN_NAME" \              --dbname=$DB_NAME \

              --title="$SITE_TITLE" \              --dbuser=$DB_USER \

              --admin_user=$ADMIN_USER \              --dbpass=$DB_PASS \

              --admin_password=$ADMIN_PASSWORD \              --dbhost=localhost \

              --admin_email=$ADMIN_EMAIL \              --allow-root

              --allow-root          

                    # Install WordPress

          # Configure WordPress settings          /usr/local/bin/wp core install \

          echo "‚öôÔ∏è Configuring WordPress..."              --url="http://$DOMAIN_NAME" \

                        --title="$SITE_TITLE" \

          # Set permalink structure              --admin_user=$ADMIN_USER \

          /usr/local/bin/wp option update permalink_structure '/%postname%/' --allow-root              --admin_password=$ADMIN_PASSWORD \

                        --admin_email=$ADMIN_EMAIL \

          # Configure timezone              --allow-root

          /usr/local/bin/wp option update timezone_string 'UTC' --allow-root          

                    # Configure WordPress settings

          # Set proper file permissions          echo "‚öôÔ∏è Configuring WordPress..."

          chown -R www-data:www-data /var/www/html          

          find /var/www/html -type d -exec chmod 755 {} \;          # Set permalink structure

          find /var/www/html -type f -exec chmod 644 {} \;          /usr/local/bin/wp option update permalink_structure '/%postname%/' --allow-root

          chmod 600 /var/www/html/wp-config.php          

                    # Configure timezone

          # Install essential plugins          /usr/local/bin/wp option update timezone_string 'UTC' --allow-root

          echo "üîå Installing essential plugins..."          

                    # Set proper file permissions

          # Install Elementor          chown -R www-data:www-data /var/www/html

          /usr/local/bin/wp plugin install elementor --activate --allow-root          find /var/www/html -type d -exec chmod 755 {} \;

                    find /var/www/html -type f -exec chmod 644 {} \;

          # Install Pods (required for Smart Gallery)          chmod 600 /var/www/html/wp-config.php

          /usr/local/bin/wp plugin install pods --activate --allow-root          

                    # Install essential plugins

          # Install WordPress SEO          echo "üîå Installing essential plugins..."

          /usr/local/bin/wp plugin install wordpress-seo --activate --allow-root          

                    # Install Elementor

          # Install security plugin          /usr/local/bin/wp plugin install elementor --activate --allow-root

          /usr/local/bin/wp plugin install wordfence --activate --allow-root          

                    # Install Pods (required for Smart Gallery)

          # Create some demo content          /usr/local/bin/wp plugin install pods --activate --allow-root

          echo "üìù Creating demo content..."          

                    # Install WordPress SEO

          # Create a sample page          /usr/local/bin/wp plugin install wordpress-seo --activate --allow-root

          /usr/local/bin/wp post create \          

              --post_type=page \          # Install security plugin

              --post_title='Smart Gallery Demo' \          /usr/local/bin/wp plugin install wordfence --activate --allow-root

              --post_content='<p>This page will showcase the Smart Gallery plugin functionality.</p>' \          

              --post_status=publish \          # Create some demo content

              --allow-root          echo "üìù Creating demo content..."

                    

          # Configure SSL with Let's Encrypt          # Create a sample page

          echo "üîí Setting up SSL certificate..."          /usr/local/bin/wp post create \

                        --post_type=page \

          # Get SSL certificate              --post_title='Smart Gallery Demo' \

          certbot --nginx \              --post_content='<p>This page will showcase the Smart Gallery plugin functionality.</p>' \

              --non-interactive \              --post_status=publish \

              --agree-tos \              --allow-root

              --email $LETSENCRYPT_EMAIL \          

              --domains $DOMAIN_NAME \          # Configure SSL with Let's Encrypt

              --redirect          echo "üîí Setting up SSL certificate..."

                    

          # Update WordPress URL to HTTPS          # Get SSL certificate

          /usr/local/bin/wp option update home "https://$DOMAIN_NAME" --allow-root          certbot --nginx \

          /usr/local/bin/wp option update siteurl "https://$DOMAIN_NAME" --allow-root              --non-interactive \

                        --agree-tos \

          # Setup auto-renewal              --email $LETSENCRYPT_EMAIL \

          echo "üîÑ Setting up certificate auto-renewal..."              --domains $DOMAIN_NAME \

          if ! crontab -l 2>/dev/null | grep -q 'certbot renew'; then              --redirect

              (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -          

          fi          # Update WordPress URL to HTTPS

                    /usr/local/bin/wp option update home "https://$DOMAIN_NAME" --allow-root

          # Store credentials for later use          /usr/local/bin/wp option update siteurl "https://$DOMAIN_NAME" --allow-root

          echo "ADMIN_USER=$ADMIN_USER" > /root/.wp-admin-config          

          echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> /root/.wp-admin-config          # Setup auto-renewal

          echo "ADMIN_EMAIL=$ADMIN_EMAIL" >> /root/.wp-admin-config          echo "üîÑ Setting up certificate auto-renewal..."

          echo "SITE_URL=https://$DOMAIN_NAME" >> /root/.wp-admin-config          if ! crontab -l 2>/dev/null | grep -q 'certbot renew'; then

          chmod 600 /root/.wp-admin-config              (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -

                    fi

          # Final Nginx reload          

          systemctl reload nginx          # Store credentials for later use

                    echo "ADMIN_USER=$ADMIN_USER" > /root/.wp-admin-config

          echo "‚úÖ Environment configuration completed successfully!"          echo "ADMIN_PASSWORD=$ADMIN_PASSWORD" >> /root/.wp-admin-config

          echo "üåê Site URL: https://$DOMAIN_NAME"          echo "ADMIN_EMAIL=$ADMIN_EMAIL" >> /root/.wp-admin-config

          echo "üë§ Admin User: $ADMIN_USER"          echo "SITE_URL=https://$DOMAIN_NAME" >> /root/.wp-admin-config

          echo "üîë Admin Password: $ADMIN_PASSWORD"          chmod 600 /root/.wp-admin-config

          echo "üìß Admin Email: $ADMIN_EMAIL"          

                    # Final Nginx reload

          touch /var/log/environment-configured          systemctl reload nginx

          EOF          

                    echo "‚úÖ Environment configuration completed successfully!"

          chmod +x configure-environment.sh          echo "üåê Site URL: https://$DOMAIN_NAME"

          echo "üë§ Admin User: $ADMIN_USER"

      # Execute configuration on VM          echo "üîë Admin Password: $ADMIN_PASSWORD"

      - name: ‚öôÔ∏è Configure Environment on VM          echo "üìß Admin Email: $ADMIN_EMAIL"

        id: configure          

        run: |          touch /var/log/environment-configured

          echo "‚öôÔ∏è Starting environment configuration..."          EOF

                    

          # Copy configuration script to VM          chmod +x configure-environment.sh

          gcloud compute scp configure-environment.sh \

            $VM_INSTANCE:~/configure-environment.sh \      # Execute configuration on VM

            --zone=$VM_ZONE \      - name: ‚öôÔ∏è Configure Environment on VM

            --quiet        id: configure

                  run: |

          # Execute configuration script          echo "‚öôÔ∏è Starting environment configuration..."

          gcloud compute ssh $VM_INSTANCE \          

            --zone=$VM_ZONE \          # Copy configuration script to VM

            --quiet \          gcloud compute scp configure-environment.sh \

            --command="            $VM_INSTANCE:~/configure-environment.sh \

              sudo chmod +x ~/configure-environment.sh            --zone=$VM_ZONE \

              sudo ~/configure-environment.sh \            --quiet

                '$DOMAIN_NAME' \          

                '$SITE_TITLE' \          # Execute configuration script

                '$ADMIN_USER' \          gcloud compute ssh $VM_INSTANCE \

                '$ADMIN_EMAIL' \            --zone=$VM_ZONE \

                '$LETSENCRYPT_EMAIL'            --quiet \

            "            --command="

                        sudo chmod +x ~/configure-environment.sh

          # Get admin password from VM              sudo ~/configure-environment.sh \

          ADMIN_PASSWORD=$(gcloud compute ssh $VM_INSTANCE \                '$DOMAIN_NAME' \

            --zone=$VM_ZONE \                '$SITE_TITLE' \

            --quiet \                '$ADMIN_USER' \

            --command="sudo grep 'ADMIN_PASSWORD=' /root/.wp-admin-config | cut -d'=' -f2")                '$ADMIN_EMAIL' \

                          '$LETSENCRYPT_EMAIL'

          echo "site_url=https://$DOMAIN_NAME" >> $GITHUB_OUTPUT            "

          echo "admin_password=$ADMIN_PASSWORD" >> $GITHUB_OUTPUT          

                    # Get admin password from VM

          echo "‚úÖ Environment configuration completed!"          ADMIN_PASSWORD=$(gcloud compute ssh $VM_INSTANCE \

            --zone=$VM_ZONE \

      # Health check            --quiet \

      - name: üè• Health Check            --command="sudo grep 'ADMIN_PASSWORD=' /root/.wp-admin-config | cut -d'=' -f2")

        env:          

          SITE_URL: https://${{ env.DOMAIN_NAME }}          echo "site_url=https://$DOMAIN_NAME" >> $GITHUB_OUTPUT

        run: |          echo "admin_password=$ADMIN_PASSWORD" >> $GITHUB_OUTPUT

          echo "üè• Running health check..."          

                    echo "‚úÖ Environment configuration completed!"

          # Wait for services to stabilize

          sleep 30      # Health check

                - name: üè• Health Check

          # Check HTTP to HTTPS redirect        env:

          echo "üîç Testing HTTP to HTTPS redirect..."          SITE_URL: https://${{ env.DOMAIN_NAME }}

          if curl -sSL -w "%{http_code}" "http://$DOMAIN_NAME" -o /dev/null | grep -q "30[1-8]"; then        run: |

            echo "‚úÖ HTTP redirects to HTTPS!"          echo "üè• Running health check..."

          else          

            echo "‚ö†Ô∏è HTTP redirect may not be working"          # Wait for services to stabilize

          fi          sleep 30

                    

          # Check HTTPS site          # Check HTTP to HTTPS redirect

          echo "üîç Testing HTTPS site..."          echo "üîç Testing HTTP to HTTPS redirect..."

          if curl -sSf "$SITE_URL" > /dev/null; then          if curl -sSL -w "%{http_code}" "http://$DOMAIN_NAME" -o /dev/null | grep -q "30[1-8]"; then

            echo "‚úÖ HTTPS site is responding!"            echo "‚úÖ HTTP redirects to HTTPS!"

          else          else

            echo "‚ùå HTTPS site health check failed!"            echo "‚ö†Ô∏è HTTP redirect may not be working"

            exit 1          fi

          fi          

                    # Check HTTPS site

          # Check WordPress admin          echo "üîç Testing HTTPS site..."

          echo "üîç Testing WordPress admin..."          if curl -sSf "$SITE_URL" > /dev/null; then

          if curl -sSf "$SITE_URL/wp-admin/" > /dev/null; then            echo "‚úÖ HTTPS site is responding!"

            echo "‚úÖ WordPress admin is accessible!"          else

          else            echo "‚ùå HTTPS site health check failed!"

            echo "‚ö†Ô∏è WordPress admin may need attention"            exit 1

          fi          fi

                    

          echo "üéâ Health check completed!"          # Check WordPress admin

          echo "üîç Testing WordPress admin..."

      # Display configuration summary          if curl -sSf "$SITE_URL/wp-admin/" > /dev/null; then

      - name: üìä Configuration Summary            echo "‚úÖ WordPress admin is accessible!"

        env:          else

          SITE_URL: ${{ steps.configure.outputs.site_url }}            echo "‚ö†Ô∏è WordPress admin may need attention"

          ADMIN_PASSWORD: ${{ steps.configure.outputs.admin_password }}          fi

        run: |          

          echo "## ‚öôÔ∏è Environment Configuration Summary" >> $GITHUB_STEP_SUMMARY          echo "üéâ Health check completed!"

          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ‚úÖ WordPress Installation:" >> $GITHUB_STEP_SUMMARY      # Display configuration summary

          echo "- **Site URL**: $SITE_URL" >> $GITHUB_STEP_SUMMARY      - name: üìä Configuration Summary

          echo "- **Admin User**: \`$ADMIN_USER\`" >> $GITHUB_STEP_SUMMARY        env:

          echo "- **Admin Password**: \`$ADMIN_PASSWORD\`" >> $GITHUB_STEP_SUMMARY          SITE_URL: ${{ steps.configure.outputs.site_url }}

          echo "- **Admin Email**: $ADMIN_EMAIL" >> $GITHUB_STEP_SUMMARY          ADMIN_PASSWORD: ${{ steps.configure.outputs.admin_password }}

          echo "" >> $GITHUB_STEP_SUMMARY        run: |

          echo "### üîí Security Features:" >> $GITHUB_STEP_SUMMARY          echo "## ‚öôÔ∏è Environment Configuration Summary" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ HTTPS Redirect" >> $GITHUB_STEP_SUMMARY          echo "### ‚úÖ WordPress Installation:" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Security Headers" >> $GITHUB_STEP_SUMMARY          echo "- **Site URL**: $SITE_URL" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Wordfence Security Plugin" >> $GITHUB_STEP_SUMMARY          echo "- **Admin User**: \`$ADMIN_USER\`" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY          echo "- **Admin Password**: \`$ADMIN_PASSWORD\`" >> $GITHUB_STEP_SUMMARY

          echo "### üîå Installed Plugins:" >> $GITHUB_STEP_SUMMARY          echo "- **Admin Email**: $ADMIN_EMAIL" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Elementor" >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Pods Framework" >> $GITHUB_STEP_SUMMARY          echo "### üîí Security Features:" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ WordPress SEO" >> $GITHUB_STEP_SUMMARY          echo "- ‚úÖ SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Wordfence Security" >> $GITHUB_STEP_SUMMARY          echo "- ‚úÖ HTTPS Redirect" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY          echo "- ‚úÖ Security Headers" >> $GITHUB_STEP_SUMMARY

          echo "### üéØ Next Steps:" >> $GITHUB_STEP_SUMMARY          echo "- ‚úÖ Wordfence Security Plugin" >> $GITHUB_STEP_SUMMARY

          echo "1. Run **Deploy Plugin** workflow" >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY

          echo "2. Access admin at: $SITE_URL/wp-admin/" >> $GITHUB_STEP_SUMMARY          echo "### üîå Installed Plugins:" >> $GITHUB_STEP_SUMMARY

          echo "3. Configure Smart Gallery widget in Elementor" >> $GITHUB_STEP_SUMMARY          echo "- ‚úÖ Elementor" >> $GITHUB_STEP_SUMMARY

          echo "- ‚úÖ Pods Framework" >> $GITHUB_STEP_SUMMARY

      # Cleanup          echo "- ‚úÖ WordPress SEO" >> $GITHUB_STEP_SUMMARY

      - name: üóëÔ∏è Cleanup          echo "- ‚úÖ Wordfence Security" >> $GITHUB_STEP_SUMMARY

        if: always()          echo "" >> $GITHUB_STEP_SUMMARY

        run: |          echo "### üéØ Next Steps:" >> $GITHUB_STEP_SUMMARY

          rm -f configure-environment.sh          echo "1. Run **Deploy Plugin** workflow" >> $GITHUB_STEP_SUMMARY

          echo "‚úÖ Configuration workflow completed"          echo "2. Access admin at: $SITE_URL/wp-admin/" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure Smart Gallery widget in Elementor" >> $GITHUB_STEP_SUMMARY

      # Cleanup
      - name: üóëÔ∏è Cleanup
        if: always()
        run: |
          rm -f configure-environment.sh
          echo "‚úÖ Configuration workflow completed"