name: "4. Configure environment âš™ï¸"

"on":
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP Project ID (optional if stored as variable)'
        required: false
        type: string
      vm_instance:
        description: 'VM Instance Name (optional if stored as variable)'
        required: false
        type: string
      vm_zone:
        description: 'VM Zone (optional if stored as variable)'
        required: false
        type: string
      domain_name:
        description: 'Domain name'
        required: true
        type: string
      site_title:
        description: 'WordPress Site Title'
        required: false
        default: 'Smart Gallery Demo'
        type: string
      admin_user:
        description: 'WordPress Admin Username'
        required: false
        default: 'admin'
        type: string
      admin_email:
        description: 'WordPress Admin Email'
        required: true
        type: string
      letsencrypt_email:
        description: "Let's Encrypt Email"
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ github.event.inputs.project_id || vars.GCP_PROJECT_ID }}
  VM_INSTANCE: ${{ github.event.inputs.vm_instance || vars.GCP_VM_INSTANCE }}
  VM_ZONE: ${{ github.event.inputs.vm_zone || vars.GCP_VM_ZONE }}
  DOMAIN_NAME: ${{ github.event.inputs.domain_name }}
  SITE_TITLE: ${{ github.event.inputs.site_title }}
  ADMIN_USER: ${{ github.event.inputs.admin_user }}
  ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}
  LETSENCRYPT_EMAIL: ${{ github.event.inputs.letsencrypt_email }}

jobs:
  verify-prerequisites:
    name: "ğŸ” Verify Prerequisites"
    runs-on: ubuntu-latest
    
    outputs:
      wp_cli_ready: ${{ steps.verify.outputs.wp_cli_ready }}
      database_ready: ${{ steps.verify.outputs.database_ready }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Verify prerequisites
      - name: ğŸ” Verify System Prerequisites
        id: verify
        run: |
          echo "ğŸ” Verifying system prerequisites..."
          
          # Check if VM is accessible
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="echo 'âœ… VM is accessible'"
          
          echo ""
          echo "ğŸ” Checking system components..."
          
          # Get detailed system status
          SYSTEM_STATUS=$(gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              echo '=== System Status Check ==='
              
              # Check WP-CLI
              echo -n 'WP-CLI: '
              if [ -f /usr/local/bin/wp ] && /usr/local/bin/wp --version >/dev/null 2>&1; then
                echo 'INSTALLED (/usr/local/bin/wp --version: '$(/usr/local/bin/wp --version)')'
                WP_CLI_OK=true
              else
                echo 'NOT FOUND or NOT WORKING'
                WP_CLI_OK=false
              fi
              
              # Check database config
              echo -n 'Database Config: '
              if [ -f /root/.wp-db-config ]; then
                echo 'FOUND (/root/.wp-db-config exists)'
                echo 'Contents:'
                cat /root/.wp-db-config | sed 's/DB_PASS=.*/DB_PASS=***hidden***/' | sed 's/^/  /'
                DB_CONFIG_OK=true
              else
                echo 'NOT FOUND (/root/.wp-db-config missing)'
                DB_CONFIG_OK=false
              fi
              
              # Check MariaDB service
              echo -n 'MariaDB Service: '
              if systemctl is-active mariadb >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check Nginx service
              echo -n 'Nginx Service: '
              if systemctl is-active nginx >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check PHP-FPM service
              echo -n 'PHP-FPM Service: '
              if systemctl is-active php8.3-fpm >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check if install packages workflow was completed
              echo -n 'Install Packages Marker: '
              if [ -f /var/log/packages-installed ]; then
                echo 'FOUND (packages installation completed)'
              else
                echo 'NOT FOUND (packages installation may not have completed)'
              fi
              
              echo '========================='
              
              # Return status
              if [ \"\$WP_CLI_OK\" = true ] && [ \"\$DB_CONFIG_OK\" = true ]; then
                echo 'STATUS:ALL_READY'
              elif [ \"\$WP_CLI_OK\" = false ]; then
                echo 'STATUS:WP_CLI_MISSING'
              elif [ \"\$DB_CONFIG_OK\" = false ]; then
                echo 'STATUS:DB_CONFIG_MISSING'
              else
                echo 'STATUS:UNKNOWN_ERROR'
              fi
            ")
          
          echo "$SYSTEM_STATUS"
          
          # Extract final status
          STATUS_LINE=$(echo "$SYSTEM_STATUS" | grep "STATUS:" | tail -1)
          STATUS=${STATUS_LINE#STATUS:}
          
          case "$STATUS" in
            "ALL_READY")
              echo ""
              echo "âœ… All prerequisites are ready!"
              echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
              echo "database_ready=true" >> $GITHUB_OUTPUT
              ;;
            "WP_CLI_MISSING")
              echo ""
              echo "âŒ WP-CLI is not installed or not working properly"
              echo "ğŸ’¡ Please run the 'Install Packages' workflow first"
              echo "wp_cli_ready=false" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
            "DB_CONFIG_MISSING")
              echo ""
              echo "âŒ Database configuration is missing"
              echo "ğŸ’¡ The 'Install Packages' workflow needs to be run to create database configuration"
              echo "ğŸ” This could mean:"
              echo "   - The workflow wasn't executed completely"
              echo "   - Database setup failed during installation"
              echo "   - Configuration file was deleted or corrupted"
              echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
            *)
              echo ""
              echo "âŒ Unknown system status or unexpected error"
              echo "ğŸ’¡ Please check the system status above and run 'Install Packages' workflow if needed"
              echo "wp_cli_ready=false" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      # Optional: Try to load database info from deployment files as fallback
      - name: ğŸ” Check Deployment Files for Database Info
        if: steps.verify.outputs.database_ready == 'false'
        run: |
          echo "ğŸ” Checking if database info exists in deployment files..."
          
          if [ -f ".deployment-info/database.json" ]; then
            echo "âœ… Found database.json in deployment files"
            echo "ğŸ“‹ Database configuration may be available from previous run"
            
            # Show database info (without password)
            echo "Database info from deployment files:"
            jq -r 'to_entries[] | select(.key != "db_password") | "\(.key): \(.value)"' .deployment-info/database.json
            
            echo ""
            echo "ğŸ’¡ You may be able to proceed, but it's recommended to verify database connectivity"
            echo "   on the VM by running the 'Install Packages' workflow to ensure everything is set up correctly."
          else
            echo "âŒ No database configuration found in deployment files either"
            echo "ğŸ’¡ You must run the 'Install Packages' workflow first to set up the system properly"
          fi

      # Show helpful next steps
      - name: ğŸ“‹ Prerequisites Summary & Next Steps
        if: failure()
        run: |
          echo "## ğŸš« Prerequisites Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Configure Environment workflow cannot proceed because required system components are missing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ Required Actions:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Run the 'Install Packages' workflow first**" >> $GITHUB_STEP_SUMMARY
          echo "2. Ensure it completes successfully without errors" >> $GITHUB_STEP_SUMMARY
          echo "3. Then retry this 'Configure Environment' workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š System Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **WP-CLI**: ${{ steps.verify.outputs.wp_cli_ready == 'true' && 'âœ… Ready' || 'âŒ Missing' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Database Config**: ${{ steps.verify.outputs.database_ready == 'true' && 'âœ… Ready' || 'âŒ Missing' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Workflow Order:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Provision Infrastructure** â†’ Create VM and networking" >> $GITHUB_STEP_SUMMARY
          echo "2. **Install Packages** â†’ Install software and configure services" >> $GITHUB_STEP_SUMMARY
          echo "3. **Configure Environment** â†’ Set up WordPress and SSL (this workflow)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Deploy Plugin** â†’ Install Smart Gallery plugin" >> $GITHUB_STEP_SUMMARY

  configure-nginx:
    name: "ğŸŒ Configure Nginx & SSL"
    runs-on: ubuntu-latest
    needs: verify-prerequisites
    if: needs.verify-prerequisites.outputs.wp_cli_ready == 'true'
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Create Nginx configuration script
      - name: ğŸ“ Create Nginx Configuration Script
        run: |
          cat > configure-nginx.sh << 'EOF'
          #!/bin/bash
          set -e
          exec > >(tee /var/log/nginx-configuration.log)
          exec 2>&1
          
          DOMAIN_NAME="$1"
          
          echo "ğŸŒ Configuring Nginx for domain: $DOMAIN_NAME - $(date)"
          
          # Remove default site
          rm -f /etc/nginx/sites-enabled/default
          
          # Create WordPress site configuration
          cat > /etc/nginx/sites-available/wordpress <<NGINX_CONF
          server {
              listen 80;
              server_name $DOMAIN_NAME;
              root /var/www/html;
              index index.php index.html index.htm;
              
              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
              
              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;
              
              location = /favicon.ico { log_not_found off; access_log off; }
              location = /robots.txt { allow all; log_not_found off; access_log off; }
              location / { try_files \$uri \$uri/ /index.php?\$args; }
              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              location ~ /\. { deny all; }
              location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt) { deny all; }
          }
          NGINX_CONF
          
          # Enable site
          ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/
          
          # Test and reload Nginx
          nginx -t
          systemctl reload nginx
          
          echo "âœ… Nginx configuration completed!"
          EOF
          
          chmod +x configure-nginx.sh

      # Execute Nginx configuration
      - name: ğŸŒ Configure Nginx
        run: |
          echo "ğŸŒ Configuring Nginx..."
          
          # Copy script to VM
          gcloud compute scp configure-nginx.sh \
            $VM_INSTANCE:~/configure-nginx.sh \
            --zone=$VM_ZONE \
            --quiet
          
          # Execute script
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              sudo chmod +x ~/configure-nginx.sh
              sudo ~/configure-nginx.sh '$DOMAIN_NAME'
            "
          
          echo "âœ… Nginx configuration completed!"

  setup-database:
    name: "ğŸ—ƒï¸ Setup Database & Security"
    runs-on: ubuntu-latest
    needs: configure-nginx
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Setup database security
      - name: ğŸ—ƒï¸ Setup Database Security
        run: |
          echo "ğŸ—ƒï¸ Setting up database security..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Load database credentials
              source /root/.wp-db-config
              
              # Generate secure root password
              DB_ROOT_PASSWORD=\$(openssl rand -base64 32)
              
              # Set MariaDB root password
              echo 'ğŸ”’ Setting MariaDB root password...'
              mysql -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY '\$DB_ROOT_PASSWORD';\"
              
              # Store root password
              echo '[client]' > /root/.my.cnf
              echo 'user=root' >> /root/.my.cnf
              echo \"password=\$DB_ROOT_PASSWORD\" >> /root/.my.cnf
              chmod 600 /root/.my.cnf
              
              echo 'âœ… Database security configured!'
            "

  install-wordpress:
    name: "ğŸ“¥ Install WordPress"
    runs-on: ubuntu-latest
    needs: setup-database
    
    outputs:
      admin_password: ${{ steps.install.outputs.admin_password }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Install WordPress
      - name: ğŸ“¥ Install WordPress
        id: install
        run: |
          echo "ğŸ“¥ Installing WordPress..."
          
          # Generate admin password
          ADMIN_PASSWORD=$(openssl rand -base64 24)
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Load database credentials
              source /root/.wp-db-config
              
              cd /var/www/html
              
              # Remove any existing files
              rm -rf *
              
              # Download WordPress
              /usr/local/bin/wp core download --allow-root
              
              # Create wp-config.php
              /usr/local/bin/wp config create \
                  --dbname=\$DB_NAME \
                  --dbuser=\$DB_USER \
                  --dbpass=\$DB_PASS \
                  --dbhost=localhost \
                  --allow-root
              
              # Install WordPress
              /usr/local/bin/wp core install \
                  --url=\"http://$DOMAIN_NAME\" \
                  --title=\"$SITE_TITLE\" \
                  --admin_user=$ADMIN_USER \
                  --admin_password='$ADMIN_PASSWORD' \
                  --admin_email=$ADMIN_EMAIL \
                  --allow-root
              
              # Configure WordPress settings
              echo 'âš™ï¸ Configuring WordPress...'
              
              # Set permalink structure
              /usr/local/bin/wp option update permalink_structure '/%postname%/' --allow-root
              
              # Configure timezone
              /usr/local/bin/wp option update timezone_string 'UTC' --allow-root
              
              # Set proper file permissions
              chown -R www-data:www-data /var/www/html
              find /var/www/html -type d -exec chmod 755 {} \;
              find /var/www/html -type f -exec chmod 644 {} \;
              chmod 600 /var/www/html/wp-config.php
              
              echo 'âœ… WordPress installation completed!'
            "
          
          echo "admin_password=$ADMIN_PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… WordPress installation completed!"

  install-plugins:
    name: "ğŸ”Œ Install Essential Plugins"
    runs-on: ubuntu-latest
    needs: install-wordpress
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Install essential plugins
      - name: ğŸ”Œ Install Essential Plugins
        run: |
          echo "ğŸ”Œ Installing essential plugins..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              cd /var/www/html
              
              # Install Elementor
              echo 'ğŸ“¦ Installing Elementor...'
              /usr/local/bin/wp plugin install elementor --activate --allow-root
              
              # Install Pods (required for Smart Gallery)
              echo 'ğŸ“¦ Installing Pods Framework...'
              /usr/local/bin/wp plugin install pods --activate --allow-root
              
              # Install WordPress SEO
              echo 'ğŸ“¦ Installing WordPress SEO...'
              /usr/local/bin/wp plugin install wordpress-seo --activate --allow-root
              
              # Install security plugin
              echo 'ğŸ“¦ Installing Wordfence Security...'
              /usr/local/bin/wp plugin install wordfence --activate --allow-root
              
              # Create demo content
              echo 'ğŸ“ Creating demo content...'
              /usr/local/bin/wp post create \
                  --post_type=page \
                  --post_title='Smart Gallery Demo' \
                  --post_content='<p>This page will showcase the Smart Gallery plugin functionality.</p>' \
                  --post_status=publish \
                  --allow-root
              
              echo 'âœ… Essential plugins installed!'
            "

  setup-ssl:
    name: "ğŸ”’ Setup SSL Certificate"
    runs-on: ubuntu-latest
    needs: install-plugins
    
    outputs:
      site_url: ${{ steps.ssl.outputs.site_url }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Setup SSL certificate
      - name: ğŸ”’ Setup SSL Certificate
        id: ssl
        run: |
          echo "ğŸ”’ Setting up SSL certificate..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Configure SSL with Let's Encrypt
              echo 'ğŸ”’ Getting SSL certificate...'
              
              # Get SSL certificate
              certbot --nginx \
                  --non-interactive \
                  --agree-tos \
                  --email $LETSENCRYPT_EMAIL \
                  --domains $DOMAIN_NAME \
                  --redirect
              
              # Update WordPress URL to HTTPS
              cd /var/www/html
              /usr/local/bin/wp option update home \"https://$DOMAIN_NAME\" --allow-root
              /usr/local/bin/wp option update siteurl \"https://$DOMAIN_NAME\" --allow-root
              
              # Setup auto-renewal
              echo 'ğŸ”„ Setting up certificate auto-renewal...'
              if ! crontab -l 2>/dev/null | grep -q 'certbot renew'; then
                  (crontab -l 2>/dev/null; echo '0 12 * * * /usr/bin/certbot renew --quiet') | crontab -
              fi
              
              # Store credentials for later use
              echo \"ADMIN_USER=$ADMIN_USER\" > /root/.wp-admin-config
              echo \"ADMIN_PASSWORD=${{ needs.install-wordpress.outputs.admin_password }}\" >> /root/.wp-admin-config
              echo \"ADMIN_EMAIL=$ADMIN_EMAIL\" >> /root/.wp-admin-config
              echo \"SITE_URL=https://$DOMAIN_NAME\" >> /root/.wp-admin-config
              chmod 600 /root/.wp-admin-config
              
              # Final Nginx reload
              systemctl reload nginx
              
              echo 'âœ… SSL certificate configured!'
            "
          
          echo "site_url=https://$DOMAIN_NAME" >> $GITHUB_OUTPUT
          echo "âœ… SSL setup completed!"

  health-check:
    name: "ğŸ¥ Health Check & Summary"
    runs-on: ubuntu-latest
    needs: [setup-ssl, install-wordpress]
    
    outputs:
      site_url: ${{ needs.setup-ssl.outputs.site_url }}
      admin_password: ${{ needs.install-wordpress.outputs.admin_password }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from deployment files
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information..."
          
          # Check if deployment info files exist
          if [ -f ".deployment-info/infrastructure.json" ]; then
            echo "âœ… Found deployment information file"
            
            # Extract information from JSON file
            VM_NAME=$(jq -r '.vm_name // ""' .deployment-info/infrastructure.json)
            VM_ZONE=$(jq -r '.vm_zone // ""' .deployment-info/infrastructure.json)
            PROJECT_ID=$(jq -r '.project_id // ""' .deployment-info/infrastructure.json)
            
            # Override environment variables if found in deployment files
            if [ -n "$VM_NAME" ]; then
              echo "VM_INSTANCE=$VM_NAME" >> $GITHUB_ENV
            fi
            if [ -n "$VM_ZONE" ]; then
              echo "VM_ZONE=$VM_ZONE" >> $GITHUB_ENV
            fi
            if [ -n "$PROJECT_ID" ]; then
              echo "GCP_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
            fi
            
            echo "ğŸ“‹ Using deployment files for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=true" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Using GitHub Variables/inputs for infrastructure info"
            echo "DEPLOYMENT_FILES_EXIST=false" >> $GITHUB_ENV
            
            # Use original environment variables
            echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
            echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
            echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${VM_INSTANCE:-Not set}"
          echo "- VM Zone: ${VM_ZONE:-Not set}"
          echo "- Project ID: ${GCP_PROJECT_ID:-Not set}"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Health check
      - name: ğŸ¥ Health Check
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
        run: |
          echo "ğŸ¥ Running health check..."
          
          # Wait for services to stabilize
          sleep 30
          
          # Check HTTP to HTTPS redirect
          echo "ğŸ” Testing HTTP to HTTPS redirect..."
          if curl -sSL -w "%{http_code}" "http://$DOMAIN_NAME" -o /dev/null | grep -q "30[1-8]"; then
            echo "âœ… HTTP redirects to HTTPS!"
          else
            echo "âš ï¸ HTTP redirect may not be working"
          fi
          
          # Check HTTPS site
          echo "ğŸ” Testing HTTPS site..."
          if curl -sSf "$SITE_URL" > /dev/null; then
            echo "âœ… HTTPS site is responding!"
          else
            echo "âŒ HTTPS site health check failed!"
            exit 1
          fi
          
          # Check WordPress admin
          echo "ğŸ” Testing WordPress admin..."
          if curl -sSf "$SITE_URL/wp-admin/" > /dev/null; then
            echo "âœ… WordPress admin is accessible!"
          else
            echo "âš ï¸ WordPress admin may need attention"
          fi
          
          echo "ğŸ‰ Health check completed!"

      # Display configuration summary
      - name: ğŸ“Š Configuration Summary
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
          ADMIN_PASSWORD: ${{ needs.install-wordpress.outputs.admin_password }}
        run: |
          echo "## âš™ï¸ Environment Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… WordPress Installation:" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: $SITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin User**: \`$ADMIN_USER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Password**: \`$ADMIN_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Email**: $ADMIN_EMAIL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ Security Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTPS Redirect" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Headers" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Wordfence Security Plugin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”Œ Installed Plugins:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Elementor" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pods Framework" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… WordPress SEO" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Wordfence Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **Deploy Plugin** workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Access admin at: $SITE_URL/wp-admin/" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure Smart Gallery widget in Elementor" >> $GITHUB_STEP_SUMMARY

      # Store environment configuration
      - name: ğŸ“Š Store Environment Configuration
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
          ADMIN_PASSWORD: ${{ needs.install-wordpress.outputs.admin_password }}
        run: |
          echo "ğŸ“Š Storing environment configuration..."
          
          # Create deployment info directory if it doesn't exist
          mkdir -p .deployment-info
          
          # Store environment configuration in deployment files
          cat > .deployment-info/environment.env << EOF
          SITE_URL=$SITE_URL
          ADMIN_USER=$ADMIN_USER
          ADMIN_PASSWORD=$ADMIN_PASSWORD
          ADMIN_EMAIL=$ADMIN_EMAIL
          DOMAIN_NAME=$DOMAIN_NAME
          SITE_TITLE=$SITE_TITLE
          LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL
          EOF
          
          echo "âœ… Environment configuration stored in deployment files"

      # Cleanup
      - name: ğŸ—‘ï¸ Cleanup
        if: always()
        run: |
          rm -f configure-nginx.sh
          echo "âœ… Configuration workflow completed"