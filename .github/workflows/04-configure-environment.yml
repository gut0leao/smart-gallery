name: "4. Configure environment âš™ï¸"

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP Project ID (optional if stored as variable)'
        required: false
        type: string
      vm_instance:
        description: 'VM Instance Name (optional if stored as variable)'
        required: false
        type: string
      vm_zone:
        description: 'VM Zone (optional if stored as variable)'
        required: false
        type: string
      domain_name:
        description: 'Domain name'
        required: true
        type: string
      site_title:
        description: 'WordPress Site Title'
        required: false
        default: 'Smart Gallery Demo'
        type: string
      admin_user:
        description: 'WordPress Admin Username'
        required: false
        default: 'admin'
        type: string
      admin_email:
        description: 'WordPress Admin Email'
        required: true
        type: string
      letsencrypt_email:
        description: "Let's Encrypt Email"
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ github.event.inputs.project_id || vars.GCP_PROJECT_ID }}
  VM_INSTANCE: ${{ github.event.inputs.vm_instance || vars.GCP_VM_INSTANCE }}
  VM_ZONE: ${{ github.event.inputs.vm_zone || vars.GCP_VM_ZONE }}
  DOMAIN_NAME: ${{ github.event.inputs.domain_name }}
  SITE_TITLE: ${{ github.event.inputs.site_title }}
  ADMIN_USER: ${{ github.event.inputs.admin_user }}
  ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}
  LETSENCRYPT_EMAIL: ${{ github.event.inputs.letsencrypt_email }}

jobs:
  verify-prerequisites:
    name: "ğŸ” Verify Prerequisites"
    runs-on: ubuntu-latest
    
    outputs:
      wp_cli_ready: ${{ steps.verify.outputs.wp_cli_ready || steps.db_recovery.outputs.wp_cli_ready }}
      database_ready: ${{ steps.verify.outputs.database_ready || steps.db_recovery.outputs.database_ready }}
      db_recovered: ${{ steps.db_recovery.outputs.db_recovered }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Verify prerequisites
      - name: ğŸ” Verify System Prerequisites
        id: verify
        run: |
          echo "ğŸ” Verifying system prerequisites..."
          
          # Check if VM is accessible
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="echo 'âœ… VM is accessible'"
          
          echo ""
          echo "ğŸ” Checking system components..."
          
          # Get detailed system status
          SYSTEM_STATUS=$(gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              echo '=== System Status Check ==='
              
              # Check WP-CLI
              echo -n 'WP-CLI: '
              if [ -f /usr/local/bin/wp ]; then
                echo -n 'FILE EXISTS - '
                # Check if it's executable
                if [ -x /usr/local/bin/wp ]; then
                  echo -n 'EXECUTABLE - '
                  # Try to get version with explicit path and error handling
                  WP_VERSION=\$(sudo /usr/local/bin/wp --version --allow-root 2>/dev/null || echo 'VERSION_FAILED')
                  if [ \"\$WP_VERSION\" != 'VERSION_FAILED' ] && [ -n \"\$WP_VERSION\" ]; then
                    echo \"WORKING (\$WP_VERSION)\"
                    WP_CLI_OK=true
                  else
                    echo \"INSTALLED but VERSION CHECK FAILED\"
                    # Try alternative check
                    if sudo /usr/local/bin/wp --help --allow-root >/dev/null 2>&1; then
                      echo 'WP-CLI responds to --help, considering OK'
                      WP_CLI_OK=true
                    else
                      WP_CLI_OK=false
                    fi
                  fi
                else
                  echo 'NOT EXECUTABLE'
                  WP_CLI_OK=false
                fi
              else
                echo 'FILE NOT FOUND'
                WP_CLI_OK=false
              fi
              
              # Check database config (using GitHub Variables approach)
              echo -n 'Database Config: '
                            # Test database connectivity using GitHub Variables
              if systemctl is-active mariadb >/dev/null 2>&1; then
                echo 'MARIADB AVAILABLE'
                DB_CONFIG_OK=true
              else
                echo 'NO DATABASE CONFIGURATION AVAILABLE'
                DB_CONFIG_OK=false
              fi
              
              # Check MariaDB service
              echo -n 'MariaDB Service: '
              if systemctl is-active mariadb >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check Nginx service
              echo -n 'Nginx Service: '
              if systemctl is-active nginx >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check PHP-FPM service
              echo -n 'PHP-FPM Service: '
              if systemctl is-active php8.3-fpm >/dev/null 2>&1; then
                echo 'RUNNING'
              else
                echo 'NOT RUNNING or NOT INSTALLED'
              fi
              
              # Check if install packages workflow was completed
              echo -n 'Install Packages Marker: '
              if [ -f /var/log/packages-installed ]; then
                echo 'FOUND (packages installation completed)'
                echo 'Marker content:'
                head -5 /var/log/packages-installed 2>/dev/null | sed 's/^/    /' || echo '    (could not read marker file)'
              else
                echo 'NOT FOUND (packages installation may not have completed)'
              fi
              
              # Additional diagnostic info
              echo
              echo '=== Additional Diagnostics ==='
              echo -n 'Current user: '
              whoami
              echo -n 'Working directory: '
              pwd
              echo -n 'PATH: '
              echo \$PATH
              echo -n 'WP-CLI file permissions: '
              ls -la /usr/local/bin/wp 2>/dev/null || echo 'FILE NOT FOUND'
              echo -n 'Database config approach: '
                            echo 'Using GitHub Variables (no /root access needed)'
              
              echo '========================='
              
              # Return status
              if [ \"\$WP_CLI_OK\" = true ] && [ \"\$DB_CONFIG_OK\" = true ]; then
                echo 'STATUS:ALL_READY'
              elif [ \"\$WP_CLI_OK\" = false ]; then
                echo 'STATUS:WP_CLI_MISSING'
              elif [ \"\$DB_CONFIG_OK\" = false ]; then
                echo 'STATUS:DB_CONFIG_MISSING'
              else
                echo 'STATUS:UNKNOWN_ERROR'
              fi
            ")
          
          echo "$SYSTEM_STATUS"
          
          # Extract final status
          STATUS_LINE=$(echo "$SYSTEM_STATUS" | grep "STATUS:" | tail -1)
          STATUS=${STATUS_LINE#STATUS:}
          
          case "$STATUS" in
            "ALL_READY")
              echo ""
              echo "âœ… All prerequisites are ready!"
              echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
              echo "database_ready=true" >> $GITHUB_OUTPUT
              ;;
            "WP_CLI_MISSING")
              echo ""
              echo "âŒ WP-CLI is not installed or not working properly"
              echo "ğŸ’¡ Please run the 'Install Packages' workflow first"
              echo "wp_cli_ready=false" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
            "DATABASE_UNAVAILABLE")
              echo ""
              echo "âŒ Database configuration is not available"
              echo "ğŸ’¡ The 'Install Packages' workflow needs to be run to set up database"
              echo "ğŸ” This could mean:"
              echo "   - The workflow wasn't executed completely"
              echo "   - Database setup failed during installation"
              echo "   - MariaDB service is not running"
              echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
            *)
              echo ""
              echo "âŒ Unknown system status or unexpected error"
              echo "ğŸ’¡ Please check the system status above and run 'Install Packages' workflow if needed"
              echo "wp_cli_ready=false" >> $GITHUB_OUTPUT
              echo "database_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      # Try to recover or recreate database configuration
      - name: ï¿½ Attempt Database Configuration Recovery
        if: steps.verify.outputs.database_ready == 'false'
        id: db_recovery
        run: |
          echo "ï¿½ Attempting database configuration recovery..."
          
          # First, check if we have database info in GitHub Variables
          if [ -f ".GitHub Variables" ]; then
            echo "âœ… Found database.json in GitHub Variables"
            echo "ğŸ“‹ Attempting to restore database configuration on VM..."
            
            # Extract database info
            DB_HOST=$(jq -r '.db_host // "localhost"' .GitHub Variables)
            DB_NAME=$(jq -r '.db_name // ""' .GitHub Variables)
            DB_USER=$(jq -r '.db_user // ""' .GitHub Variables)
            
            # Try to get password from GitHub Secret first, then fallback to deployment file
            if [ -n "${{ secrets.WP_DB_PASSWORD }}" ]; then
              echo "âœ… Using database password from GitHub Secret"
              DB_PASSWORD="${{ secrets.WP_DB_PASSWORD }}"
              PASSWORD_SOURCE="GitHub Secret"
            else
              echo "âš ï¸ GitHub Secret not available, trying deployment file..."
              DB_PASSWORD=$(jq -r '.db_password // ""' .GitHub Variables)
              PASSWORD_SOURCE="Deployment File"
            fi
            
            if [ -n "$DB_NAME" ] && [ -n "$DB_USER" ] && [ -n "$DB_PASSWORD" ]; then
              echo "ğŸ“‹ Database credentials found, restoring to VM..."
              echo "ğŸ” Password source: $PASSWORD_SOURCE"
              
              # Create database recovery script with proper variable handling
              cat > db_recovery.sh << 'EOF'
              #!/bin/bash
              set -e
              
              DB_HOST="$1"
              DB_NAME="$2" 
              DB_USER="$3"
              DB_PASSWORD="$4"
              
              echo "ğŸ”§ Loading database configuration from GitHub Variables..."
              echo "- Host: $DB_HOST"
              echo "- Database: $DB_NAME"
              echo "- User: $DB_USER"
              echo "- Password length: ${#DB_PASSWORD} characters"
              
              # Test database connectivity first
              echo "ğŸ” Testing database connectivity..."
              if mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SELECT 1;" >/dev/null 2>&1; then
                echo "âœ… Database connectivity successful!"
              else
                echo "âš ï¸ Database connectivity failed, attempting to fix..."
                
                # Check if database exists
                if mysql -e "USE \`$DB_NAME\`;" >/dev/null 2>&1; then
                  echo "ğŸ“‹ Database exists, recreating user..."
                  mysql -e "DROP USER IF EXISTS '$DB_USER'@'localhost';" 2>/dev/null || true
                  mysql -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';" || exit 1
                  mysql -e "GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';" || exit 1
                  mysql -e "FLUSH PRIVILEGES;" || exit 1
                else
                  echo "ğŸ”§ Database missing, recreating everything..."
                  mysql -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;" || exit 1
                  mysql -e "DROP USER IF EXISTS '$DB_USER'@'localhost';" 2>/dev/null || true
                  mysql -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';" || exit 1
                  mysql -e "GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'localhost';" || exit 1
                  mysql -e "FLUSH PRIVILEGES;" || exit 1
                fi
                
                # Test again
                if ! mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SELECT 1;" >/dev/null 2>&1; then
                  echo "âŒ Database repair failed"
                  echo "REPAIR_FAILED" > /tmp/db-recovery-status
                  exit 1
                fi
                echo "âœ… Database repaired successfully!"
              fi
              
              # Store database credentials for workflow use (no file creation needed)
              echo "ğŸ’¾ Database credentials verified and available..."
              echo "âœ… Database setup confirmed - using GitHub Variables approach"
              echo "SUCCESS" > /tmp/db-recovery-status
              EOF
              
              # Copy and execute recovery script on VM
              gcloud compute scp db_recovery.sh \
                $VM_INSTANCE:~/db_recovery.sh \
                --zone=$VM_ZONE \
                --quiet
              
              gcloud compute ssh $VM_INSTANCE \
                --zone=$VM_ZONE \
                --quiet \
                --command="chmod +x ~/db_recovery.sh && ~/db_recovery.sh '$DB_HOST' '$DB_NAME' '$DB_USER' '$DB_PASSWORD'"
              
              # Clean up script
              gcloud compute ssh $VM_INSTANCE \
                --zone=$VM_ZONE \
                --quiet \
                --command="rm -f ~/db_recovery.sh" || true
              
              # Check recovery status
              RECOVERY_STATUS=$(gcloud compute ssh $VM_INSTANCE \
                --zone=$VM_ZONE \
                --quiet \
                --command="cat /tmp/db-recovery-status 2>/dev/null || echo 'FAILED'")
              
              if [ "$RECOVERY_STATUS" = "SUCCESS" ]; then
                echo "âœ… Database configuration successfully restored!"
                echo "ğŸ‰ You can now proceed with the Configure Environment workflow"
                echo "db_recovered=true" >> $GITHUB_OUTPUT
                
                # Override the verify outputs to allow continuation
                echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
                echo "database_ready=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ Database configuration restore failed or connectivity issues"
                echo "ğŸ’¡ Please run the 'Install Packages' workflow to set up fresh database"
                echo "db_recovered=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Incomplete database information in GitHub Variables"
              echo "db_recovered=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ No database configuration found in GitHub Variables"
            echo "ğŸ’¡ Attempting to create standard WordPress database setup..."
            
            # Try to create standard WordPress database if MariaDB is running
            gcloud compute ssh $VM_INSTANCE \
              --zone=$VM_ZONE \
              --quiet \
              --command="
                echo 'Checking if MariaDB is available for database setup...'
                
                if systemctl is-active mariadb >/dev/null 2>&1; then
                  echo 'MariaDB is running, creating standard WordPress database...'
                  
                  # Use standard WordPress database credentials
                  DB_NAME='wordpress'
                  DB_USER='wordpress'  
                  DB_PASS=\$(openssl rand -base64 32)
                  
                  echo \"Creating database: \$DB_NAME with user: \$DB_USER\"
                  
                  # Check if database already exists
                  if mysql -e \"USE \$DB_NAME\" 2>/dev/null; then
                    echo 'Database exists, checking/recreating user...'
                    mysql -e \"DROP USER IF EXISTS '\$DB_USER'@'localhost';\" 2>/dev/null || true
                  else
                    echo 'Creating new database...'
                    mysql -e \"CREATE DATABASE IF NOT EXISTS \\\`\$DB_NAME\\\`;\" || { echo 'Failed to create database'; exit 1; }
                  fi
                  
                  # Create user and grant permissions
                  mysql -e \"CREATE USER '\$DB_USER'@'localhost' IDENTIFIED BY '\$DB_PASS';\" || { echo 'Failed to create user'; exit 1; }
                  mysql -e \"GRANT ALL PRIVILEGES ON \\\`\$DB_NAME\\\`.* TO '\$DB_USER'@'localhost';\" || { echo 'Failed to grant privileges'; exit 1; }
                  mysql -e \"FLUSH PRIVILEGES;\" || { echo 'Failed to flush privileges'; exit 1; }
                  
                  # Test database connection
                  if mysql -u\"\$DB_USER\" -p\"\$DB_PASS\" -e \"USE \\\`\$DB_NAME\\\`; SELECT 1;\" >/dev/null 2>&1; then
                    echo 'Database connection test successful'
                    
                    # Database credentials are available via GitHub Variables
                    echo 'Database ready - credentials stored in GitHub Variables'
                    
                    echo 'BASIC_SETUP_SUCCESS' > /tmp/db-recovery-status
                    echo \"Database: \$DB_NAME, User: \$DB_USER, Password: \${#DB_PASS} chars\" > /tmp/db-info
                    
                    # Also store in a basic deployment file for future use
                    # # Database credentials available from GitHub Variables
          {
            \"db_host\": \"localhost\",
            \"db_name\": \"\$DB_NAME\",
            \"db_user\": \"\$DB_USER\", 
            \"db_password\": \"\$DB_PASS\",
            \"created_at\": \"\$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"created_by\": \"configure-environment-recovery\"
          }
          DBEOF
                  else
                    echo 'Database connection test failed'
                    echo 'BASIC_SETUP_FAILED' > /tmp/db-recovery-status
                  fi
                else
                  echo 'MariaDB is not running'
                  echo 'MARIADB_NOT_RUNNING' > /tmp/db-recovery-status
                fi
              "
            
            RECOVERY_STATUS=$(gcloud compute ssh $VM_INSTANCE \
              --zone=$VM_ZONE \
              --quiet \
              --command="cat /tmp/db-recovery-status 2>/dev/null || echo 'FAILED'")
            
            if [ "$RECOVERY_STATUS" = "BASIC_SETUP_SUCCESS" ]; then
              echo "âœ… Basic database setup completed!"
              
              # Get the database info and store it
              DB_INFO=$(gcloud compute ssh $VM_INSTANCE \
                --zone=$VM_ZONE \
                --quiet \
                --command="cat /tmp/db-info 2>/dev/null")
              
              echo "ğŸ“‹ Created: $DB_INFO"
              echo "ğŸ‰ You can now proceed with the Configure Environment workflow"
              echo "db_recovered=true" >> $GITHUB_OUTPUT
              echo "wp_cli_ready=true" >> $GITHUB_OUTPUT
              echo "database_ready=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Basic database setup failed"
              echo "ğŸ’¡ Please run the 'Install Packages' workflow for complete setup"
              echo "db_recovered=false" >> $GITHUB_OUTPUT
            fi
          fi

      # Show helpful next steps
      - name: ğŸ“‹ Prerequisites Summary & Next Steps
        if: failure()
        run: |
          echo "## ğŸš« Prerequisites Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Configure Environment workflow cannot proceed because required system components are missing." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ Required Actions:" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.db_recovery.outputs.db_recovered }}" = "true" ]; then
            echo "âœ… **Database configuration was automatically recovered!**" >> $GITHUB_STEP_SUMMARY
            echo "- The workflow should now proceed to the next steps" >> $GITHUB_STEP_SUMMARY
            echo "- If it still fails, check the system diagnostics above" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. **Run the 'Install Packages' workflow first**" >> $GITHUB_STEP_SUMMARY
            echo "2. Ensure it completes successfully without errors" >> $GITHUB_STEP_SUMMARY
            echo "3. Then retry this 'Configure Environment' workflow" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š System Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **WP-CLI**: ${{ (steps.verify.outputs.wp_cli_ready == 'true' || steps.db_recovery.outputs.wp_cli_ready == 'true') && 'âœ… Ready' || 'âŒ Missing' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Database Config**: ${{ (steps.verify.outputs.database_ready == 'true' || steps.db_recovery.outputs.database_ready == 'true') && 'âœ… Ready' || 'âŒ Missing' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.db_recovery.outputs.db_recovered }}" = "true" ]; then
            echo "- **Recovery Status**: âœ… Database configuration recovered" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.db_recovery.outputs.db_recovered }}" = "false" ]; then
            echo "- **Recovery Status**: âŒ Automatic recovery failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Workflow Order:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Provision Infrastructure** â†’ Create VM and networking" >> $GITHUB_STEP_SUMMARY
          echo "2. **Install Packages** â†’ Install software and configure services" >> $GITHUB_STEP_SUMMARY
          echo "3. **Configure Environment** â†’ Set up WordPress and SSL (this workflow)" >> $GITHUB_STEP_SUMMARY
          echo "4. **Deploy Plugin** â†’ Install Smart Gallery plugin" >> $GITHUB_STEP_SUMMARY

  configure-nginx:
    name: "ğŸŒ Configure Nginx & SSL"
    runs-on: ubuntu-latest
    needs: verify-prerequisites
    if: needs.verify-prerequisites.outputs.wp_cli_ready == 'true' && (needs.verify-prerequisites.outputs.database_ready == 'true' || needs.verify-prerequisites.outputs.db_recovered == 'true')
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Create Nginx configuration script
      - name: ğŸ“ Create Nginx Configuration Script
        run: |
          cat > configure-nginx.sh << 'EOF'
          #!/bin/bash
          set -e
          exec > >(tee /var/log/nginx-configuration.log)
          exec 2>&1
          
          DOMAIN_NAME="$1"
          
          echo "ğŸŒ Configuring Nginx for domain: $DOMAIN_NAME - $(date)"
          
          # Remove default site
          rm -f /etc/nginx/sites-enabled/default
          
          # Create WordPress site configuration
          cat > /etc/nginx/sites-available/wordpress <<NGINX_CONF
          server {
              listen 80;
              server_name $DOMAIN_NAME;
              root /var/www/html;
              index index.php index.html index.htm;
              
              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;
              add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
              
              # Gzip compression
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript application/json;
              
              location = /favicon.ico { log_not_found off; access_log off; }
              location = /robots.txt { allow all; log_not_found off; access_log off; }
              location / { try_files \$uri \$uri/ /index.php?\$args; }
              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              location ~ /\. { deny all; }
              location ~ ^/(wp-config\.php|wp-config-sample\.php|readme\.html|license\.txt) { deny all; }
          }
          NGINX_CONF
          
          # Enable site
          ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/
          
          # Test and reload Nginx
          nginx -t
          systemctl reload nginx
          
          echo "âœ… Nginx configuration completed!"
          EOF
          
          chmod +x configure-nginx.sh

      # Execute Nginx configuration
      - name: ğŸŒ Configure Nginx
        run: |
          echo "ğŸŒ Configuring Nginx..."
          
          # Copy script to VM
          gcloud compute scp configure-nginx.sh \
            $VM_INSTANCE:~/configure-nginx.sh \
            --zone=$VM_ZONE \
            --quiet
          
          # Execute script
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              sudo chmod +x ~/configure-nginx.sh
              sudo ~/configure-nginx.sh '$DOMAIN_NAME'
            "
          
          echo "âœ… Nginx configuration completed!"

  setup-database:
    name: "ğŸ—ƒï¸ Setup Database & Security"
    runs-on: ubuntu-latest
    needs: configure-nginx
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Setup database security
      - name: ğŸ—ƒï¸ Setup Database Security
        run: |
          echo "ğŸ—ƒï¸ Setting up database security..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Load database credentials from GitHub Variables
              if [ -f ~/.GitHub Variables ]; then
                DB_HOST=\$(jq -r '.db_host // "localhost"' ~/.GitHub Variables)
                DB_NAME=\$(jq -r '.db_name // "wordpress"' ~/.GitHub Variables)
                DB_USER=\$(jq -r '.db_user // "wordpress"' ~/.GitHub Variables)
                DB_PASS=\$(jq -r '.db_password // ""' ~/.GitHub Variables)
              else
                # Fallback to standard values
                DB_HOST='localhost'
                DB_NAME='wordpress'
                DB_USER='wordpress'
                DB_PASS='wordpress_password'
              fi
              
              # Generate secure root password
              DB_ROOT_PASSWORD=\$(openssl rand -base64 32)
              
              # Set MariaDB root password
              echo 'ğŸ”’ Setting MariaDB root password...'
              mysql -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY '\$DB_ROOT_PASSWORD';\"
              
              # Store root password
              echo '[client]' > /root/.my.cnf
              echo 'user=root' >> /root/.my.cnf
              echo \"password=\$DB_ROOT_PASSWORD\" >> /root/.my.cnf
              chmod 600 /root/.my.cnf
              
              echo 'âœ… Database security configured!'
            "

  install-wordpress:
    name: "ğŸ“¥ Install WordPress"
    runs-on: ubuntu-latest
    needs: setup-database
    
    outputs:
      admin_password: ${{ steps.install.outputs.admin_password }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Install WordPress
      - name: ğŸ“¥ Install WordPress
        id: install
        run: |
          echo "ğŸ“¥ Installing WordPress..."
          
          # Generate admin password
          ADMIN_PASSWORD=$(openssl rand -base64 24)
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Load database credentials from GitHub Variables
              if [ -f ~/.GitHub Variables ]; then
                DB_HOST=\$(jq -r '.db_host // "localhost"' ~/.GitHub Variables)
                DB_NAME=\$(jq -r '.db_name // "wordpress"' ~/.GitHub Variables)
                DB_USER=\$(jq -r '.db_user // "wordpress"' ~/.GitHub Variables)
                DB_PASS=\$(jq -r '.db_password // ""' ~/.GitHub Variables)
              else
                # Fallback to standard values
                DB_HOST='localhost'
                DB_NAME='wordpress'
                DB_USER='wordpress'
                DB_PASS='wordpress_password'
              fi
              
              cd /var/www/html
              
              # Remove any existing files
              rm -rf *
              
              # Download WordPress
              /usr/local/bin/wp core download --allow-root
              
              # Create wp-config.php
              /usr/local/bin/wp config create \
                  --dbname=\$DB_NAME \
                  --dbuser=\$DB_USER \
                  --dbpass=\$DB_PASS \
                  --dbhost=localhost \
                  --allow-root
              
              # Install WordPress
              /usr/local/bin/wp core install \
                  --url=\"http://$DOMAIN_NAME\" \
                  --title=\"$SITE_TITLE\" \
                  --admin_user=$ADMIN_USER \
                  --admin_password='$ADMIN_PASSWORD' \
                  --admin_email=$ADMIN_EMAIL \
                  --allow-root
              
              # Configure WordPress settings
              echo 'âš™ï¸ Configuring WordPress...'
              
              # Set permalink structure
              /usr/local/bin/wp option update permalink_structure '/%postname%/' --allow-root
              
              # Configure timezone
              /usr/local/bin/wp option update timezone_string 'UTC' --allow-root
              
              # Set proper file permissions
              chown -R www-data:www-data /var/www/html
              find /var/www/html -type d -exec chmod 755 {} \;
              find /var/www/html -type f -exec chmod 644 {} \;
              chmod 600 /var/www/html/wp-config.php
              
              echo 'âœ… WordPress installation completed!'
            "
          
          echo "admin_password=$ADMIN_PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… WordPress installation completed!"

  install-plugins:
    name: "ğŸ”Œ Install Essential Plugins"
    runs-on: ubuntu-latest
    needs: install-wordpress
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Install essential plugins
      - name: ğŸ”Œ Install Essential Plugins
        run: |
          echo "ğŸ”Œ Installing essential plugins..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              cd /var/www/html
              
              # Install Elementor
              echo 'ğŸ“¦ Installing Elementor...'
              /usr/local/bin/wp plugin install elementor --activate --allow-root
              
              # Install Pods (required for Smart Gallery)
              echo 'ğŸ“¦ Installing Pods Framework...'
              /usr/local/bin/wp plugin install pods --activate --allow-root
              
              # Install WordPress SEO
              echo 'ğŸ“¦ Installing WordPress SEO...'
              /usr/local/bin/wp plugin install wordpress-seo --activate --allow-root
              
              # Install security plugin
              echo 'ğŸ“¦ Installing Wordfence Security...'
              /usr/local/bin/wp plugin install wordfence --activate --allow-root
              
              # Create demo content
              echo 'ğŸ“ Creating demo content...'
              /usr/local/bin/wp post create \
                  --post_type=page \
                  --post_title='Smart Gallery Demo' \
                  --post_content='<p>This page will showcase the Smart Gallery plugin functionality.</p>' \
                  --post_status=publish \
                  --allow-root
              
              echo 'âœ… Essential plugins installed!'
            "

  setup-ssl:
    name: "ğŸ”’ Setup SSL Certificate"
    runs-on: ubuntu-latest
    needs: install-plugins
    
    outputs:
      site_url: ${{ steps.ssl.outputs.site_url }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Setup SSL certificate
      - name: ğŸ”’ Setup SSL Certificate
        id: ssl
        run: |
          echo "ğŸ”’ Setting up SSL certificate..."
          
          gcloud compute ssh $VM_INSTANCE \
            --zone=$VM_ZONE \
            --quiet \
            --command="
              # Configure SSL with Let's Encrypt
              echo 'ğŸ”’ Getting SSL certificate...'
              
              # Get SSL certificate
              certbot --nginx \
                  --non-interactive \
                  --agree-tos \
                  --email $LETSENCRYPT_EMAIL \
                  --domains $DOMAIN_NAME \
                  --redirect
              
              # Update WordPress URL to HTTPS
              cd /var/www/html
              /usr/local/bin/wp option update home \"https://$DOMAIN_NAME\" --allow-root
              /usr/local/bin/wp option update siteurl \"https://$DOMAIN_NAME\" --allow-root
              
              # Setup auto-renewal
              echo 'ğŸ”„ Setting up certificate auto-renewal...'
              if ! crontab -l 2>/dev/null | grep -q 'certbot renew'; then
                  (crontab -l 2>/dev/null; echo '0 12 * * * /usr/bin/certbot renew --quiet') | crontab -
              fi
              
              # Store credentials for later use
              echo \"ADMIN_USER=$ADMIN_USER\" > /root/.wp-admin-config
              echo \"ADMIN_PASSWORD=${{ needs.install-wordpress.outputs.admin_password }}\" >> /root/.wp-admin-config
              echo \"ADMIN_EMAIL=$ADMIN_EMAIL\" >> /root/.wp-admin-config
              echo \"SITE_URL=https://$DOMAIN_NAME\" >> /root/.wp-admin-config
              chmod 600 /root/.wp-admin-config
              
              # Final Nginx reload
              systemctl reload nginx
              
              echo 'âœ… SSL certificate configured!'
            "
          
          echo "site_url=https://$DOMAIN_NAME" >> $GITHUB_OUTPUT
          echo "âœ… SSL setup completed!"

  health-check:
    name: "ğŸ¥ Health Check & Summary"
    runs-on: ubuntu-latest
    needs: [setup-ssl, install-wordpress]
    
    outputs:
      site_url: ${{ needs.setup-ssl.outputs.site_url }}
      admin_password: ${{ needs.install-wordpress.outputs.admin_password }}
    
    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # Load infrastructure information from GitHub Variables only
      - name: ğŸ” Load Infrastructure Information
        id: load_info
        run: |
          echo "ğŸ” Loading infrastructure information from GitHub Variables..."
          
          # Use GitHub Variables directly (no file dependencies)
          echo "VM_INSTANCE=${{ env.VM_INSTANCE }}" >> $GITHUB_ENV
          echo "VM_ZONE=${{ env.VM_ZONE }}" >> $GITHUB_ENV
          echo "GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          
          echo "ğŸ“Š Infrastructure Information:"
          echo "- VM Instance: ${{ env.VM_INSTANCE }}"
          echo "- VM Zone: ${{ env.VM_ZONE }}"
          echo "- Project ID: ${{ env.GCP_PROJECT_ID }}"
          echo "ğŸ“¡ Using GitHub Variables for all infrastructure info (no files needed)"

      # Authenticate to GCP
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Setup Google Cloud SDK
      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Health check
      - name: ğŸ¥ Health Check
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
        run: |
          echo "ğŸ¥ Running health check..."
          
          # Wait for services to stabilize
          sleep 30
          
          # Check HTTP to HTTPS redirect
          echo "ğŸ” Testing HTTP to HTTPS redirect..."
          if curl -sSL -w "%{http_code}" "http://$DOMAIN_NAME" -o /dev/null | grep -q "30[1-8]"; then
            echo "âœ… HTTP redirects to HTTPS!"
          else
            echo "âš ï¸ HTTP redirect may not be working"
          fi
          
          # Check HTTPS site
          echo "ğŸ” Testing HTTPS site..."
          if curl -sSf "$SITE_URL" > /dev/null; then
            echo "âœ… HTTPS site is responding!"
          else
            echo "âŒ HTTPS site health check failed!"
            exit 1
          fi
          
          # Check WordPress admin
          echo "ğŸ” Testing WordPress admin..."
          if curl -sSf "$SITE_URL/wp-admin/" > /dev/null; then
            echo "âœ… WordPress admin is accessible!"
          else
            echo "âš ï¸ WordPress admin may need attention"
          fi
          
          echo "ğŸ‰ Health check completed!"

      # Display configuration summary
      - name: ğŸ“Š Configuration Summary
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
          ADMIN_PASSWORD: ${{ needs.install-wordpress.outputs.admin_password }}
        run: |
          echo "## âš™ï¸ Environment Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… WordPress Installation:" >> $GITHUB_STEP_SUMMARY
          echo "- **Site URL**: $SITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin User**: \`$ADMIN_USER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Password**: \`$ADMIN_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Email**: $ADMIN_EMAIL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ Security Features:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTPS Redirect" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Headers" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Wordfence Security Plugin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”Œ Installed Plugins:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Elementor" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pods Framework" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… WordPress SEO" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Wordfence Security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **Deploy Plugin** workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Access admin at: $SITE_URL/wp-admin/" >> $GITHUB_STEP_SUMMARY
          echo "3. Configure Smart Gallery widget in Elementor" >> $GITHUB_STEP_SUMMARY

      # Environment configuration completed - using GitHub Variables only
      - name: âœ… Environment Configuration Summary
        env:
          SITE_URL: ${{ needs.setup-ssl.outputs.site_url }}
          ADMIN_PASSWORD: ${{ needs.install-wordpress.outputs.admin_password }}
        run: |
          echo "âœ… Environment configuration completed successfully!"
          echo ""
          echo "ğŸ“Š Configuration Summary (stored in GitHub Variables):"
          echo "- Site URL: $SITE_URL âœ…"
          echo "- Admin User: $ADMIN_USER âœ…"
          echo "- Admin Email: $ADMIN_EMAIL âœ…"
          echo "- Domain: $DOMAIN_NAME âœ…"
          echo "- Site Title: $SITE_TITLE âœ…"
          echo "- Let's Encrypt Email: $LETSENCRYPT_EMAIL âœ…"
          echo "ğŸ” Admin Password: Securely generated âœ…"
          echo ""
          echo "ğŸš€ Ready for 'Deploy Plugin' workflow!"
          echo "ğŸ’¡ No GitHub Variables created - all data in GitHub Variables"

      # Cleanup
      - name: ğŸ—‘ï¸ Cleanup
        if: always()
        run: |
          rm -f configure-nginx.sh
          echo "âœ… Configuration workflow completed"