# Fixed authentication order: auth@v2 before setup-gcloud@v2  
name: 1. Cleanup GCP Resources

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP Project ID to clean'
        required: true
        type: string
      force_cleanup:
        description: 'Force cleanup without confirmation'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run mode (show what would be deleted)'
        required: false
        default: true
        type: boolean

env:
  GCP_PROJECT_ID: ${{ github.event.inputs.project_id }}

jobs:
  cleanup:
    name: 🧹 Clean GCP Resources
    runs-on: ubuntu-latest
    environment: production  # Adicione o nome do seu environment aqui
    
    steps:
      # Checkout for cleanup script
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      # Check authentication method
      - name: 🔍 Check GCP Authentication
        id: check_auth
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "auth_method=credentials_json" >> $GITHUB_OUTPUT
            echo "✅ Using service account JSON credentials"
          elif [ -n "${{ secrets.WIF_PROVIDER }}" ] && [ -n "${{ secrets.WIF_SERVICE_ACCOUNT }}" ]; then
            echo "auth_method=workload_identity" >> $GITHUB_OUTPUT
            echo "✅ Using workload identity federation"
          else
            echo "❌ Error: No GCP authentication configured"
            echo "Please configure either:"
            echo "1. GCP_SA_KEY secret (service account JSON), OR"
            echo "2. WIF_PROVIDER + WIF_SERVICE_ACCOUNT secrets (workload identity)"
            exit 1
          fi

      # Authenticate to GCP (Service Account JSON)
      - name: 🔐 Authenticate with Service Account
        if: steps.check_auth.outputs.auth_method == 'credentials_json'
        id: auth_sa
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Authenticate to GCP (Workload Identity)
      - name: 🔐 Authenticate with Workload Identity
        if: steps.check_auth.outputs.auth_method == 'workload_identity'
        id: auth_wif
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Setup Google Cloud SDK  
      - name: ☁️ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Prepare credentials for cleanup script
      - name: 🔧 Prepare Cleanup Environment
        run: |
          # Create credentials directory
          mkdir -p .credentials
          
          # Create service account file if using JSON credentials
          if [ "${{ steps.check_auth.outputs.auth_method }}" = "credentials_json" ]; then
            echo '${{ secrets.GCP_SA_KEY }}' > .credentials/service-account.json
          fi
          
          # Make cleanup script executable
          chmod +x scripts/gcp-cleanup.sh

      # Run cleanup with appropriate mode
      - name: 🧹 Execute GCP Cleanup
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          FORCE: ${{ github.event.inputs.force_cleanup }}
        run: |
          echo "🧹 Starting GCP resource cleanup..."
          echo "Project: ${{ env.GCP_PROJECT_ID }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "Force: ${{ github.event.inputs.force_cleanup }}"
          
          # Execute cleanup script
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "🔍 DRY RUN MODE - No resources will be deleted"
            (echo "${{ env.GCP_PROJECT_ID }}"; echo "y") | DRY_RUN=true ./scripts/gcp-cleanup.sh
          else
            echo "⚠️ REAL CLEANUP MODE - Resources will be DELETED!"
            if [ "${{ github.event.inputs.force_cleanup }}" = "true" ]; then
              (echo "${{ env.GCP_PROJECT_ID }}"; echo "y"; echo "y") | DRY_RUN=false FORCE=true ./scripts/gcp-cleanup.sh
            else
              echo "❌ Real cleanup requires force_cleanup=true for safety"
              exit 1
            fi
          fi

      # Cleanup sensitive files
      - name: 🗑️ Cleanup Sensitive Files
        if: always()
        run: |
          rm -rf .credentials/
          echo "✅ Cleanup completed"

      # Summary
      - name: 📊 Cleanup Summary
        if: success()
        run: |
          echo "## 🧹 GCP Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ env.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Real Cleanup' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY